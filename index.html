<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-APEX Rate Management System</title>
    <style>
        /* ============================================================
           K-APEX RMS - Orange/Grey Theme
           ============================================================ */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --orange-primary: #FF8C00;
            --orange-dark: #E07800;
            --orange-light: #FFF3E0;
            --orange-hover: #FF6B00;
            --grey-900: #1a1a2e;
            --grey-800: #2d2d44;
            --grey-700: #3d3d56;
            --grey-600: #4a4a5e;
            --grey-500: #6b6b80;
            --grey-400: #8e8e9f;
            --grey-300: #b0b0be;
            --grey-200: #d4d4de;
            --grey-100: #eeeef3;
            --grey-50: #f7f7fa;
            --white: #ffffff;
            --red: #dc3545;
            --green: #28a745;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--grey-800) 0%, var(--grey-900) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--grey-800);
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-hover) 100%);
            color: var(--white);
            padding: 30px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left h1 {
            font-size: 2em;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }
        .header-left p {
            font-size: 1em;
            opacity: 0.9;
            margin-top: 4px;
        }
        .header-right {
            text-align: right;
            font-size: 0.85em;
            opacity: 0.9;
        }
        .header-right .stat { margin-bottom: 2px; }
        .header-right .stat strong { font-size: 1.2em; }

        /* Search & Filter Bar */
        .filter-bar {
            padding: 24px 40px;
            background: var(--grey-50);
            border-bottom: 2px solid var(--grey-200);
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .filter-group label {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--grey-500);
        }
        .filter-group input,
        .filter-group select {
            padding: 10px 14px;
            font-size: 0.95em;
            border: 2px solid var(--grey-200);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: var(--white);
        }
        .filter-group input:focus,
        .filter-group select:focus {
            border-color: var(--orange-primary);
            box-shadow: 0 0 0 3px rgba(255,140,0,0.15);
        }
        #searchDest { width: 260px; }
        #searchSupplier { width: 220px; }
        #filterRegion { width: 240px; }
        #filterOrigin { width: 240px; }

        .filter-actions {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .btn {
            padding: 10px 20px;
            font-size: 0.95em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--orange-primary);
            color: var(--white);
        }
        .btn-primary:hover { background: var(--orange-hover); }
        .btn-secondary {
            background: var(--grey-200);
            color: var(--grey-700);
        }
        .btn-secondary:hover { background: var(--grey-300); }

        /* Autocomplete */
        .autocomplete-wrapper { position: relative; }
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--grey-200);
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .autocomplete-list div {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--grey-100);
            font-size: 0.9em;
        }
        .autocomplete-list div:hover,
        .autocomplete-list div.active {
            background: var(--orange-light);
            color: var(--orange-dark);
        }

        /* Results Info Bar */
        .results-info {
            padding: 12px 40px;
            background: var(--grey-100);
            font-size: 0.85em;
            color: var(--grey-500);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .results-info strong { color: var(--orange-primary); font-size: 1.1em; }

        /* Results Table */
        .results-section {
            padding: 0 20px 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            font-size: 0.9em;
        }
        thead { position: sticky; top: 0; z-index: 10; }
        th {
            background: linear-gradient(135deg, var(--grey-700) 0%, var(--grey-800) 100%);
            color: var(--white);
            padding: 12px 14px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: background 0.2s;
        }
        th:hover { background: var(--grey-600); }
        th .sort-arrow { margin-left: 4px; font-size: 0.7em; opacity: 0.6; }
        th.sorted .sort-arrow { opacity: 1; color: var(--orange-primary); }
        td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--grey-100);
            white-space: nowrap;
        }
        tr { cursor: pointer; transition: background 0.15s; }
        tr:hover { background: var(--orange-light); }
        tr.selected { background: #ffe0b2; }
        .rate-cell {
            font-weight: 700;
            color: var(--grey-800);
        }
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .tag-yes { background: #d4edda; color: #155724; }
        .tag-no { background: var(--grey-100); color: var(--grey-500); }
        .region-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            background: var(--grey-200);
            color: var(--grey-700);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
            overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--white);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: modalIn 0.25s ease-out;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-hover) 100%);
            color: var(--white);
            padding: 20px 30px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 1.3em; }
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: var(--white);
            font-size: 1.5em;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .modal-close:hover { background: rgba(255,255,255,0.4); }
        .modal-body { padding: 24px 30px; }

        /* Modal Tabs */
        .modal-tabs {
            display: flex;
            border-bottom: 2px solid var(--grey-200);
            margin-bottom: 20px;
            gap: 0;
        }
        .modal-tab {
            padding: 10px 20px;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--grey-500);
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .modal-tab:hover { color: var(--grey-700); }
        .modal-tab.active {
            color: var(--orange-primary);
            border-bottom-color: var(--orange-primary);
        }
        .modal-panel { display: none; }
        .modal-panel.active { display: block; }

        /* Rate Summary in Modal */
        .rate-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .rate-summary-item {
            background: var(--grey-50);
            padding: 14px 18px;
            border-radius: 10px;
            border-left: 4px solid var(--orange-primary);
        }
        .rate-summary-item .label {
            font-size: 0.75em;
            text-transform: uppercase;
            color: var(--grey-500);
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .rate-summary-item .value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--grey-800);
        }
        .rate-summary-item .value.highlight {
            color: var(--orange-primary);
            font-size: 1.4em;
        }

        /* Accessorial Table in Modal */
        .acc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .acc-table th {
            background: var(--grey-700);
            color: var(--white);
            padding: 10px 14px;
            text-align: left;
            font-size: 0.8em;
            cursor: default;
        }
        .acc-table th:hover { background: var(--grey-700); }
        .acc-table td {
            padding: 8px 14px;
            border-bottom: 1px solid var(--grey-100);
            white-space: normal;
        }
        .acc-table tr:nth-child(even) { background: var(--grey-50); }
        .acc-table tr:hover { background: var(--orange-light); }
        .section-label {
            background: var(--grey-100) !important;
            font-weight: 700;
            color: var(--grey-700);
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        /* Contact Cards */
        .contact-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .contact-card {
            background: var(--grey-50);
            border-radius: 10px;
            padding: 16px 20px;
            border-left: 4px solid var(--grey-400);
        }
        .contact-card.dispatch { border-left-color: var(--orange-primary); }
        .contact-card.priority { border-left-color: #2196F3; }
        .contact-card.back-up { border-left-color: #9C27B0; }
        .contact-card.escalation { border-left-color: var(--red); }
        .contact-card .role-label {
            font-size: 0.7em;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .contact-card.dispatch .role-label { color: var(--orange-primary); }
        .contact-card.priority .role-label { color: #2196F3; }
        .contact-card.back-up .role-label { color: #9C27B0; }
        .contact-card.escalation .role-label { color: var(--red); }
        .contact-card .contact-name {
            font-size: 1.05em;
            font-weight: 600;
            color: var(--grey-800);
            margin-bottom: 2px;
        }
        .contact-card .contact-position {
            font-size: 0.85em;
            color: var(--grey-500);
            margin-bottom: 8px;
        }
        .contact-card .contact-detail {
            font-size: 0.85em;
            color: var(--grey-700);
            margin-bottom: 3px;
        }
        .contact-card .contact-detail a {
            color: var(--orange-primary);
            text-decoration: none;
        }
        .contact-card .contact-detail a:hover { text-decoration: underline; }

        /* General/capabilities section */
        .capabilities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .cap-item {
            background: var(--grey-50);
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cap-item .cap-label {
            font-size: 0.85em;
            color: var(--grey-600);
        }
        .cap-item .cap-value {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--grey-800);
        }
        .cap-yes { color: var(--green) !important; }
        .cap-no { color: var(--red) !important; }

        /* No results / loading */
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--grey-400);
        }
        .no-results h2 { color: var(--orange-primary); margin-bottom: 12px; }
        .loading { text-align: center; padding: 60px; color: var(--grey-400); font-size: 1.1em; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px;
        }
        .pagination button {
            padding: 8px 16px;
            border: 1px solid var(--grey-200);
            background: var(--white);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .pagination button:hover:not(:disabled) {
            background: var(--orange-light);
            border-color: var(--orange-primary);
        }
        .pagination button:disabled {
            opacity: 0.4;
            cursor: default;
        }
        .pagination .page-info {
            font-size: 0.85em;
            color: var(--grey-500);
        }

        /* FSC Banner */
        .fsc-banner {
            padding: 8px 40px;
            background: var(--grey-800);
            color: var(--grey-300);
            font-size: 0.78em;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }
        .fsc-banner .fsc-item span { color: var(--orange-primary); font-weight: 600; }

        /* Footer */
        .footer {
            padding: 16px 40px;
            background: var(--grey-50);
            border-top: 1px solid var(--grey-200);
            text-align: center;
            font-size: 0.78em;
            color: var(--grey-400);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .header { flex-direction: column; text-align: center; gap: 12px; }
            .filter-bar { padding: 16px 20px; }
            #searchDest, #searchSupplier, #filterRegion, #filterOrigin { width: 100%; }
            .filter-group { width: 100%; }
            .results-section { padding: 0 8px 16px; }
            .modal-body { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>K-APEX Rate Management System</h1>
                <p>Drayage Rate Search &amp; Vendor Information</p>
            </div>
            <div class="header-right">
                <div class="stat"><strong id="statRates">-</strong> rates</div>
                <div class="stat"><strong id="statDests">-</strong> destinations</div>
                <div class="stat"><strong id="statVendors">-</strong> vendors</div>
            </div>
        </div>

        <!-- FSC Banner -->
        <div class="fsc-banner" id="fscBanner"></div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group autocomplete-wrapper">
                <label>Destination City</label>
                <input type="text" id="searchDest" placeholder="Search destination..." autocomplete="off">
                <div class="autocomplete-list" id="destAutocomplete"></div>
            </div>
            <div class="filter-group">
                <label>Region</label>
                <select id="filterRegion">
                    <option value="">All Regions</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Origin</label>
                <select id="filterOrigin">
                    <option value="">All Origins</option>
                </select>
            </div>
            <div class="filter-group autocomplete-wrapper">
                <label>Supplier</label>
                <input type="text" id="searchSupplier" placeholder="Search supplier..." autocomplete="off">
                <div class="autocomplete-list" id="supplierAutocomplete"></div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">Search</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
            </div>
        </div>

        <!-- Results Info -->
        <div class="results-info" id="resultsInfo">
            <span>Enter a search term or select filters to find rates.</span>
            <span></span>
        </div>

        <!-- Results Table -->
        <div class="results-section">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th data-col="region" onclick="sortBy('region')">Region <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="origin" onclick="sortBy('origin')">Origin <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="destinationCity" onclick="sortBy('destinationCity')">Destination <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="supplier" onclick="sortBy('supplier')">Supplier <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="baseRate" onclick="sortBy('baseRate')">Base Rate <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="fscPercent" onclick="sortBy('fscPercent')">FSC % <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="baseAndFsc" onclick="sortBy('baseAndFsc')">Base + FSC <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="freeDropPick" onclick="sortBy('freeDropPick')">Free Drop/Pick <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="layoverFee" onclick="sortBy('layoverFee')">Layover <span class="sort-arrow">&#9650;</span></th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination"></div>

        <!-- Footer -->
        <div class="footer">
            K-APEX Rate Management System &bull; Rates valid per region-specific contract periods &bull; FSC updated monthly
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">Rate Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Rate Summary -->
                <div class="rate-summary" id="modalSummary"></div>

                <!-- Tabs -->
                <div class="modal-tabs" id="modalTabs">
                    <button class="modal-tab active" onclick="switchTab('accessorials')">Accessorial Charges</button>
                    <button class="modal-tab" onclick="switchTab('contacts')">Contact Information</button>
                    <button class="modal-tab" onclick="switchTab('capabilities')">Vendor Capabilities</button>
                </div>

                <!-- Panels -->
                <div class="modal-panel active" id="panel-accessorials"></div>
                <div class="modal-panel" id="panel-contacts"></div>
                <div class="modal-panel" id="panel-capabilities"></div>
            </div>
        </div>
    </div>

    <script>
    /* ================================================================
       FUEL SURCHARGE CONFIGURATION
       ================================================================
       Update these values monthly. They are applied to base rates
       to calculate the all-in rate: baseRate * (1 + fscPercent).
       FSC percentages from Feb 2026 Fuel PDF.
       ================================================================ */
    const FSC_CONFIG = {
        "California":                     0.425,   // 42.5%
        "Gulf Coast":                     0.285,   // 28.5%
        "Lower Atlantic":                 0.310,   // 31.0%
        "Midwest":                        0.310,   // 31.0%
        "New England & Central Atlantic": 0.345,   // Blended NE 35.5% + CA 34%
        "PNW Rocky Mountain":             0.290,   // 29.0% (Rocky Mountain base)
    };

    /* ================================================================
       DATA
       ================================================================ */
    let ratesData = [];
    let contactsData = [];
    let accessorialsData = [];
    let filteredRates = [];
    let currentSort = { col: 'baseAndFsc', dir: 'asc' };
    let currentPage = 1;
    const PAGE_SIZE = 100;

    /* ================================================================
       INITIALIZATION
       ================================================================ */
    async function init() {
        try {
            const [ratesResp, contactsResp, accResp] = await Promise.all([
                fetch('data/rates.json'),
                fetch('data/contacts.json'),
                fetch('data/accessorials.json')
            ]);

            if (!ratesResp.ok || !contactsResp.ok || !accResp.ok) {
                throw new Error('Failed to load data files. Ensure data/*.json files are present.');
            }

            ratesData = await ratesResp.json();
            contactsData = await contactsResp.json();
            accessorialsData = await accResp.json();

            // Populate stats
            const regions = new Set(ratesData.map(r => r.region));
            const destinations = new Set(ratesData.map(r => r.destinationCity));
            const suppliers = new Set(ratesData.map(r => r.supplier));

            document.getElementById('statRates').textContent = ratesData.length.toLocaleString();
            document.getElementById('statDests').textContent = destinations.size.toLocaleString();
            document.getElementById('statVendors').textContent = suppliers.size.toLocaleString();

            // Populate FSC banner
            renderFscBanner();

            // Populate region filter
            const regionSelect = document.getElementById('filterRegion');
            Array.from(regions).sort().forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                regionSelect.appendChild(opt);
            });

            // Populate origin filter
            populateOrigins();

            // Region change updates origins
            regionSelect.addEventListener('change', populateOrigins);

            // Set up autocomplete
            setupAutocomplete('searchDest', 'destAutocomplete', () => {
                return [...new Set(ratesData.map(r => r.destinationCity))].sort();
            });
            setupAutocomplete('searchSupplier', 'supplierAutocomplete', () => {
                return [...new Set(ratesData.map(r => r.supplier))].sort();
            });

            // Enter key triggers search
            document.getElementById('searchDest').addEventListener('keydown', e => {
                if (e.key === 'Enter') applyFilters();
            });
            document.getElementById('searchSupplier').addEventListener('keydown', e => {
                if (e.key === 'Enter') applyFilters();
            });

            // Show welcome state
            document.getElementById('resultsBody').innerHTML = '';

        } catch (error) {
            console.error('Init error:', error);
            document.getElementById('resultsBody').innerHTML =
                `<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--red);">
                    Error loading data: ${error.message}
                </td></tr>`;
        }
    }

    function renderFscBanner() {
        const banner = document.getElementById('fscBanner');
        banner.innerHTML = Object.entries(FSC_CONFIG).map(([region, pct]) =>
            `<div class="fsc-item">${region}: <span>${(pct * 100).toFixed(1)}%</span></div>`
        ).join('');
    }

    function populateOrigins() {
        const regionVal = document.getElementById('filterRegion').value;
        const originSelect = document.getElementById('filterOrigin');
        originSelect.innerHTML = '<option value="">All Origins</option>';

        let origins;
        if (regionVal) {
            origins = [...new Set(ratesData.filter(r => r.region === regionVal).map(r => r.origin))].sort();
        } else {
            origins = [...new Set(ratesData.map(r => r.origin))].sort();
        }
        origins.forEach(o => {
            if (!o) return;
            const opt = document.createElement('option');
            opt.value = o;
            opt.textContent = o;
            originSelect.appendChild(opt);
        });
    }

    /* ================================================================
       AUTOCOMPLETE
       ================================================================ */
    function setupAutocomplete(inputId, listId, getItems) {
        const input = document.getElementById(inputId);
        const list = document.getElementById(listId);
        let currentFocus = -1;

        input.addEventListener('input', () => {
            const val = input.value.toLowerCase();
            list.innerHTML = '';
            currentFocus = -1;
            if (!val) return;

            const matches = getItems().filter(item =>
                item.toLowerCase().includes(val)
            ).slice(0, 12);

            matches.forEach(item => {
                const div = document.createElement('div');
                div.textContent = item;
                div.addEventListener('click', () => {
                    input.value = item;
                    list.innerHTML = '';
                    applyFilters();
                });
                list.appendChild(div);
            });
        });

        input.addEventListener('keydown', e => {
            const items = list.querySelectorAll('div');
            if (e.key === 'ArrowDown') {
                currentFocus++;
                setActive(items, currentFocus);
            } else if (e.key === 'ArrowUp') {
                currentFocus--;
                setActive(items, currentFocus);
            } else if (e.key === 'Enter' && currentFocus > -1) {
                e.preventDefault();
                items[currentFocus]?.click();
            }
        });

        function setActive(items, idx) {
            items.forEach(i => i.classList.remove('active'));
            if (idx >= items.length) currentFocus = 0;
            if (idx < 0) currentFocus = items.length - 1;
            items[currentFocus]?.classList.add('active');
        }

        document.addEventListener('click', e => {
            if (e.target !== input) list.innerHTML = '';
        });
    }

    /* ================================================================
       FILTERING & SEARCH
       ================================================================ */
    function applyFilters() {
        const dest = document.getElementById('searchDest').value.trim().toLowerCase();
        const region = document.getElementById('filterRegion').value;
        const origin = document.getElementById('filterOrigin').value;
        const supplier = document.getElementById('searchSupplier').value.trim().toLowerCase();

        // Close autocomplete lists
        document.getElementById('destAutocomplete').innerHTML = '';
        document.getElementById('supplierAutocomplete').innerHTML = '';

        filteredRates = ratesData.filter(r => {
            if (dest && !r.destinationCity.toLowerCase().includes(dest)) return false;
            if (region && r.region !== region) return false;
            if (origin && r.origin !== origin) return false;
            if (supplier && !r.supplier.toLowerCase().includes(supplier)) return false;
            return true;
        });

        // Apply current sort
        sortData();
        currentPage = 1;
        renderResults();
    }

    function clearFilters() {
        document.getElementById('searchDest').value = '';
        document.getElementById('filterRegion').value = '';
        document.getElementById('filterOrigin').value = '';
        document.getElementById('searchSupplier').value = '';
        populateOrigins();
        filteredRates = [];
        document.getElementById('resultsBody').innerHTML = '';
        document.getElementById('resultsInfo').innerHTML =
            '<span>Enter a search term or select filters to find rates.</span><span></span>';
        document.getElementById('pagination').innerHTML = '';
    }

    /* ================================================================
       SORTING
       ================================================================ */
    function sortBy(col) {
        if (currentSort.col === col) {
            currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.col = col;
            currentSort.dir = 'asc';
        }

        // Update header indicators
        document.querySelectorAll('th').forEach(th => {
            th.classList.remove('sorted');
            th.querySelector('.sort-arrow').innerHTML = '&#9650;';
        });
        const activeTh = document.querySelector(`th[data-col="${col}"]`);
        if (activeTh) {
            activeTh.classList.add('sorted');
            activeTh.querySelector('.sort-arrow').innerHTML =
                currentSort.dir === 'asc' ? '&#9650;' : '&#9660;';
        }

        sortData();
        renderResults();
    }

    function sortData() {
        const { col, dir } = currentSort;
        filteredRates.sort((a, b) => {
            let va = a[col];
            let vb = b[col];

            // Numeric columns
            if (['baseRate', 'fscPercent', 'baseAndFsc'].includes(col)) {
                va = va ?? Infinity;
                vb = vb ?? Infinity;
                return dir === 'asc' ? va - vb : vb - va;
            }

            // String columns
            va = (va ?? '').toString().toLowerCase();
            vb = (vb ?? '').toString().toLowerCase();
            if (va < vb) return dir === 'asc' ? -1 : 1;
            if (va > vb) return dir === 'asc' ? 1 : -1;
            return 0;
        });
    }

    /* ================================================================
       RENDERING
       ================================================================ */
    function formatCurrency(val) {
        if (val === null || val === undefined || isNaN(val)) return '-';
        return '$' + parseFloat(val).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatPercent(val) {
        if (val === null || val === undefined || isNaN(val)) return '-';
        return (parseFloat(val) * 100).toFixed(1) + '%';
    }

    function yesNoTag(val) {
        const v = (val ?? '').toString().trim().toUpperCase();
        if (v === 'Y' || v === 'YES') return '<span class="tag tag-yes">Yes</span>';
        return '<span class="tag tag-no">No</span>';
    }

    function renderResults() {
        const tbody = document.getElementById('resultsBody');
        const info = document.getElementById('resultsInfo');
        const pag = document.getElementById('pagination');

        if (filteredRates.length === 0) {
            tbody.innerHTML = '';
            info.innerHTML = '<span>No rates found matching your criteria.</span><span></span>';
            pag.innerHTML = '';
            return;
        }

        const totalPages = Math.ceil(filteredRates.length / PAGE_SIZE);
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = Math.min(start + PAGE_SIZE, filteredRates.length);
        const pageRates = filteredRates.slice(start, end);

        info.innerHTML = `
            <span>Showing <strong>${start + 1}-${end}</strong> of <strong>${filteredRates.length.toLocaleString()}</strong> rates</span>
            <span>Sorted by ${currentSort.col} (${currentSort.dir})</span>
        `;

        tbody.innerHTML = pageRates.map((r, idx) => `
            <tr onclick="openModal(${start + idx})">
                <td><span class="region-badge">${r.region}</span></td>
                <td>${r.origin}</td>
                <td>${r.destinationCity}</td>
                <td>${r.supplier}</td>
                <td class="rate-cell">${formatCurrency(r.baseRate)}</td>
                <td>${formatPercent(r.fscPercent)}</td>
                <td class="rate-cell" style="color:var(--orange-primary)">${formatCurrency(r.baseAndFsc)}</td>
                <td>${yesNoTag(r.freeDropPick)}</td>
                <td>${yesNoTag(r.layoverFee)}</td>
            </tr>
        `).join('');

        // Pagination
        pag.innerHTML = `
            <button onclick="goPage(1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>
            <button onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>
            <span class="page-info">Page ${currentPage} of ${totalPages}</span>
            <button onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next &rsaquo;</button>
            <button onclick="goPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>
        `;
    }

    function goPage(page) {
        currentPage = page;
        renderResults();
        document.getElementById('resultsTable').scrollIntoView({ behavior: 'smooth' });
    }

    /* ================================================================
       MODAL - Rate Detail
       ================================================================ */
    function openModal(idx) {
        const rate = filteredRates[idx];
        if (!rate) return;

        // Title
        document.getElementById('modalTitle').textContent =
            `${rate.supplier} — ${rate.origin} → ${rate.destinationCity}`;

        // Rate summary
        document.getElementById('modalSummary').innerHTML = `
            <div class="rate-summary-item">
                <div class="label">Region</div>
                <div class="value">${rate.region}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">Origin</div>
                <div class="value">${rate.origin}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">Destination</div>
                <div class="value">${rate.destinationCity}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">Base Rate</div>
                <div class="value">${formatCurrency(rate.baseRate)}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">FSC</div>
                <div class="value">${formatPercent(rate.fscPercent)}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">All-In Rate (Base + FSC)</div>
                <div class="value highlight">${formatCurrency(rate.baseAndFsc)}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">Free Drop/Pick</div>
                <div class="value">${(rate.freeDropPick || 'N').toUpperCase() === 'Y' ? 'Yes' : 'No'}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">Layover Fee</div>
                <div class="value">${(rate.layoverFee || 'N').toUpperCase() === 'Y' ? 'Yes' : 'No'}</div>
            </div>
        `;

        // Find matching accessorial data
        const acc = findAccessorial(rate.supplier, rate.region);
        renderAccessorialsPanel(acc);

        // Find matching contacts
        const contacts = findContacts(rate.supplier, rate.region);
        renderContactsPanel(contacts);

        // Render capabilities
        renderCapabilitiesPanel(acc);

        // Show modal, default to first tab
        switchTab('accessorials');
        document.getElementById('modalOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(event) {
        if (event && event.target !== document.getElementById('modalOverlay')) return;
        document.getElementById('modalOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }

    // Close on Escape
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }
    });

    function switchTab(tabName) {
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.modal-panel').forEach(p => p.classList.remove('active'));

        const tabs = document.querySelectorAll('.modal-tab');
        const tabMap = { accessorials: 0, contacts: 1, capabilities: 2 };
        tabs[tabMap[tabName]]?.classList.add('active');
        document.getElementById(`panel-${tabName}`).classList.add('active');
    }

    /* ================================================================
       VENDOR MATCHING
       ================================================================ */
    function normalizeVendor(name) {
        if (!name) return '';
        let n = name.trim().toUpperCase();
        n = n.replace(/,?\s*\bLLC\b\.?/g, '');
        n = n.replace(/,?\s*\bINC\b\.?/g, '');
        n = n.replace(/,?\s*\bCORP\b\.?/g, '');
        n = n.replace(/,?\s*\bLTD\b\.?/g, '');
        n = n.replace(/,?\s*\bCO\b\./g, '');
        n = n.replace(/\s*\(.*?\)/g, '');
        n = n.replace(/[^A-Z0-9 ]/g, ' ');
        n = n.replace(/\s+/g, ' ').trim();
        return n;
    }

    function normalizeVendorNospace(name) {
        return normalizeVendor(name).replace(/[^A-Z0-9]/g, '');
    }

    function findAccessorial(supplierName, region) {
        const normSupplier = normalizeVendor(supplierName);
        const nsSupplier = normalizeVendorNospace(supplierName);

        // First try exact region + normalized name match
        let match = accessorialsData.find(a =>
            a.region === region &&
            (normalizeVendor(a.vendor) === normSupplier ||
             (a.vendorNospace || normalizeVendorNospace(a.vendor)) === nsSupplier)
        );

        // Try substring matching
        if (!match) {
            match = accessorialsData.find(a => {
                if (a.region !== region) return false;
                const av = normalizeVendor(a.vendor);
                const avns = a.vendorNospace || normalizeVendorNospace(a.vendor);
                return av.includes(normSupplier) || normSupplier.includes(av) ||
                       avns.includes(nsSupplier) || nsSupplier.includes(avns);
            });
        }

        return match;
    }

    function findContacts(supplierName, region) {
        const normSupplier = normalizeVendor(supplierName);
        const nsSupplier = normalizeVendorNospace(supplierName);

        return contactsData.filter(c => {
            if (c.region !== region) return false;
            const cv = normalizeVendor(c.company);
            const cvns = normalizeVendorNospace(c.company);
            return cv === normSupplier ||
                   cvns === nsSupplier ||
                   cv.includes(normSupplier) || normSupplier.includes(cv) ||
                   cvns.includes(nsSupplier) || nsSupplier.includes(cvns);
        });
    }

    /* ================================================================
       MODAL PANELS
       ================================================================ */
    function renderAccessorialsPanel(acc) {
        const panel = document.getElementById('panel-accessorials');

        if (!acc || !acc.fees || Object.keys(acc.fees).length === 0) {
            panel.innerHTML = '<p style="color:var(--grey-400);padding:20px;text-align:center;">No accessorial charge data available for this vendor in this region.</p>';
            return;
        }

        const fees = acc.fees;
        const feeLabels = {
            yardStorageFreeTime: 'Yard Storage Free Time (24hr periods)',
            yardStorageCost: 'Yard Storage Cost (per 24hr)',
            warehouseWaitFreeTime: 'Warehouse Wait Free Time (hours)',
            warehouseWaitFee: 'Warehouse Wait Fee (per hour)',
            prePull: 'Pre-Pull (incl. first 24hrs yard storage)',
            hazmatFee: 'HAZMAT / DG Fee',
            reeferFee: 'Reefer Fee',
            chassisFee: 'Chassis Fee (per day)',
            chassisSplitFee: 'Chassis Split Fee (incl. fuel)',
            triaxleFee: 'Triaxle Fee',
            overweightFee: 'Overweight Fee',
            dryRunFee: 'Dry Run Fee (incl. fuel)',
            stopOffFee: 'Stop Off Fee (incl. fuel)',
            dropPickFee: 'Drop & Pick Fee (incl. bobtail)',
            layoverFee: 'Layover Fee (incl. fuel)',
            bondedFee: 'Bonded Fee',
            residentialDeliveryFee: 'Residential Delivery Fee',
        };

        let html = '<table class="acc-table"><thead><tr><th>Charge</th><th>Rate / Terms</th></tr></thead><tbody>';

        // Free Time section
        html += '<tr class="section-label"><td colspan="2">Free Time</td></tr>';
        ['yardStorageFreeTime', 'yardStorageCost', 'warehouseWaitFreeTime', 'warehouseWaitFee'].forEach(key => {
            const val = fees[key] ?? '-';
            html += `<tr><td>${feeLabels[key]}</td><td><strong>${formatFeeValue(val)}</strong></td></tr>`;
        });

        // Fees section
        html += '<tr class="section-label"><td colspan="2">Fees</td></tr>';
        ['prePull', 'hazmatFee', 'reeferFee', 'chassisFee', 'chassisSplitFee', 'triaxleFee',
         'overweightFee', 'dryRunFee', 'stopOffFee', 'dropPickFee', 'layoverFee', 'bondedFee',
         'residentialDeliveryFee'].forEach(key => {
            const val = fees[key] ?? '-';
            html += `<tr><td>${feeLabels[key]}</td><td><strong>${formatFeeValue(val)}</strong></td></tr>`;
        });

        html += '</tbody></table>';
        panel.innerHTML = html;
    }

    function formatFeeValue(val) {
        if (!val || val === '-' || val === 'None') return '-';
        const num = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
        if (!isNaN(num) && String(val).match(/^[\$\s]*[\d,.]+\s*$/)) {
            return '$' + num.toFixed(2);
        }
        return val;
    }

    function renderContactsPanel(contacts) {
        const panel = document.getElementById('panel-contacts');

        if (!contacts || contacts.length === 0) {
            panel.innerHTML = '<p style="color:var(--grey-400);padding:20px;text-align:center;">No contact information available for this vendor in this region.</p>';
            return;
        }

        // Order by role
        const roleOrder = { 'Dispatch': 0, 'Priority': 1, 'Back-up': 2, 'Escalation': 3 };
        contacts.sort((a, b) => (roleOrder[a.role] ?? 99) - (roleOrder[b.role] ?? 99));

        const html = '<div class="contact-cards">' + contacts.map(c => {
            const roleClass = (c.role || '').toLowerCase().replace(/[^a-z-]/g, '');
            return `
                <div class="contact-card ${roleClass}">
                    <div class="role-label">${c.role || 'Contact'}</div>
                    <div class="contact-name">${c.contactName || '-'}</div>
                    <div class="contact-position">${c.position || ''}</div>
                    ${c.email ? `<div class="contact-detail">Email: <a href="mailto:${c.email}">${c.email}</a></div>` : ''}
                    ${c.phone ? `<div class="contact-detail">Phone: <a href="tel:${c.phone}">${c.phone}</a></div>` : ''}
                    ${c.pickupTerminal ? `<div class="contact-detail">Terminal: ${c.pickupTerminal}</div>` : ''}
                    ${c.remarks ? `<div class="contact-detail" style="margin-top:6px;font-style:italic;color:var(--grey-400);">${c.remarks}</div>` : ''}
                </div>
            `;
        }).join('') + '</div>';

        panel.innerHTML = html;
    }

    function renderCapabilitiesPanel(acc) {
        const panel = document.getElementById('panel-capabilities');

        if (!acc || !acc.general || Object.keys(acc.general).length === 0) {
            panel.innerHTML = '<p style="color:var(--grey-400);padding:20px;text-align:center;">No vendor capability data available.</p>';
            return;
        }

        const gen = acc.general;
        const capLabels = {
            tracking: 'Provides Tracking',
            trackingSystem: 'Tracking System',
            trackingAccuracy: 'Tracking Accuracy',
            willingToUseOurTracking: 'Will Use Our Tracking',
            hazmatCapable: 'HAZMAT / DG Capable',
            assetVehicles: 'Asset Vehicles in Area',
            leasedChassis: 'Leased/Owned Chassis',
            insuranceCoverage: '$1M+ Insurance',
            bondedService: 'Bonded Service',
        };

        function capClass(val) {
            const v = (val ?? '').toString().trim().toLowerCase();
            if (v === 'yes' || v === 'true') return 'cap-yes';
            if (v === 'no' || v === 'false') return 'cap-no';
            return '';
        }

        const html = '<div class="capabilities-grid">' +
            Object.entries(capLabels).map(([key, label]) => {
                const val = gen[key] ?? '-';
                return `
                    <div class="cap-item">
                        <span class="cap-label">${label}</span>
                        <span class="cap-value ${capClass(val)}">${val}</span>
                    </div>
                `;
            }).join('') + '</div>';

        panel.innerHTML = html;
    }

    /* ================================================================
       INIT
       ================================================================ */
    window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
