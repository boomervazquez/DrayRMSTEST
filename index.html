<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-APEX Rate Management System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        /* ============================================================
           K-APEX RMS - Orange/Grey Theme
           ============================================================ */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --orange-primary: #FF8C00;
            --orange-dark: #E07800;
            --orange-light: #FFF3E0;
            --orange-hover: #FF6B00;
            --grey-900: #1a1a2e;
            --grey-800: #2d2d44;
            --grey-700: #3d3d56;
            --grey-600: #4a4a5e;
            --grey-500: #6b6b80;
            --grey-400: #8e8e9f;
            --grey-300: #b0b0be;
            --grey-200: #d4d4de;
            --grey-100: #eeeef3;
            --grey-50: #f7f7fa;
            --white: #ffffff;
            --red: #dc3545;
            --green: #28a745;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--grey-800) 0%, var(--grey-900) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--grey-800);
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-hover) 100%);
            color: var(--white);
            padding: 30px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left h1 {
            font-size: 2em;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }
        .header-left p {
            font-size: 1em;
            opacity: 0.9;
            margin-top: 4px;
        }
        .header-right {
            text-align: right;
            font-size: 0.85em;
            opacity: 0.9;
        }
        .header-right .stat { margin-bottom: 2px; }
        .header-right .stat strong { font-size: 1.2em; }

        /* Search & Filter Bar */
        .filter-bar {
            padding: 24px 40px;
            background: var(--grey-50);
            border-bottom: 2px solid var(--grey-200);
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .filter-group label {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--grey-500);
        }
        .filter-group input,
        .filter-group select {
            padding: 10px 14px;
            font-size: 0.95em;
            border: 2px solid var(--grey-200);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: var(--white);
        }
        .filter-group input:focus,
        .filter-group select:focus {
            border-color: var(--orange-primary);
            box-shadow: 0 0 0 3px rgba(255,140,0,0.15);
        }
        #searchDest { width: 260px; }
        #searchSupplier { width: 220px; }
        #filterRegion { width: 240px; }
        #filterOrigin { width: 240px; }

        .filter-actions {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .btn {
            padding: 10px 20px;
            font-size: 0.95em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--orange-primary);
            color: var(--white);
        }
        .btn-primary:hover { background: var(--orange-hover); }
        .btn-secondary {
            background: var(--grey-200);
            color: var(--grey-700);
        }
        .btn-secondary:hover { background: var(--grey-300); }

        /* Autocomplete */
        .autocomplete-wrapper { position: relative; }
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--grey-200);
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .autocomplete-list div {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--grey-100);
            font-size: 0.9em;
        }
        .autocomplete-list div:hover,
        .autocomplete-list div.active {
            background: var(--orange-light);
            color: var(--orange-dark);
        }

        /* Results Info Bar */
        .results-info {
            padding: 12px 40px;
            background: var(--grey-100);
            font-size: 0.85em;
            color: var(--grey-500);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .results-info strong { color: var(--orange-primary); font-size: 1.1em; }

        /* Results Table */
        .results-section {
            padding: 0 20px 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            font-size: 0.9em;
        }
        thead { position: sticky; top: 0; z-index: 10; }
        th {
            background: linear-gradient(135deg, var(--grey-700) 0%, var(--grey-800) 100%);
            color: var(--white);
            padding: 12px 14px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: background 0.2s;
        }
        th:hover { background: var(--grey-600); }
        th .sort-arrow { margin-left: 4px; font-size: 0.7em; opacity: 0.6; }
        th.sorted .sort-arrow { opacity: 1; color: var(--orange-primary); }
        td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--grey-100);
            white-space: nowrap;
        }
        tr { cursor: pointer; transition: background 0.15s; }
        tr:hover { background: var(--orange-light); }
        tr.selected { background: #ffe0b2; }
        .rate-cell {
            font-weight: 700;
            color: var(--grey-800);
        }
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .tag-yes { background: #d4edda; color: #155724; }
        .tag-no { background: var(--grey-100); color: var(--grey-500); }
        .region-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            background: var(--grey-200);
            color: var(--grey-700);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
            overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--white);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: modalIn 0.25s ease-out;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-hover) 100%);
            color: var(--white);
            padding: 20px 30px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 1.3em; }
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: var(--white);
            font-size: 1.5em;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .modal-close:hover { background: rgba(255,255,255,0.4); }
        .modal-body { padding: 24px 30px; }

        /* Modal Tabs */
        .modal-tabs {
            display: flex;
            border-bottom: 2px solid var(--grey-200);
            margin-bottom: 20px;
            gap: 0;
        }
        .modal-tab {
            padding: 10px 20px;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--grey-500);
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .modal-tab:hover { color: var(--grey-700); }
        .modal-tab.active {
            color: var(--orange-primary);
            border-bottom-color: var(--orange-primary);
        }
        .modal-panel { display: none; }
        .modal-panel.active { display: block; }

        /* Rate Summary in Modal */
        .rate-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .rate-summary-item {
            background: var(--grey-50);
            padding: 14px 18px;
            border-radius: 10px;
            border-left: 4px solid var(--orange-primary);
        }
        .rate-summary-item .label {
            font-size: 0.75em;
            text-transform: uppercase;
            color: var(--grey-500);
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .rate-summary-item .value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--grey-800);
        }
        .rate-summary-item .value.highlight {
            color: var(--orange-primary);
            font-size: 1.4em;
        }

        /* Accessorial Table in Modal */
        .acc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .acc-table th {
            background: var(--grey-700);
            color: var(--white);
            padding: 10px 14px;
            text-align: left;
            font-size: 0.8em;
            cursor: default;
        }
        .acc-table th:hover { background: var(--grey-700); }
        .acc-table td {
            padding: 8px 14px;
            border-bottom: 1px solid var(--grey-100);
            white-space: normal;
        }
        .acc-table tr:nth-child(even) { background: var(--grey-50); }
        .acc-table tr:hover { background: var(--orange-light); }
        .section-label {
            background: var(--grey-100) !important;
            font-weight: 700;
            color: var(--grey-700);
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        /* Contact Cards */
        .contact-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .contact-card {
            background: var(--grey-50);
            border-radius: 10px;
            padding: 16px 20px;
            border-left: 4px solid var(--grey-400);
        }
        .contact-card.dispatch { border-left-color: var(--orange-primary); }
        .contact-card.priority { border-left-color: #2196F3; }
        .contact-card.back-up { border-left-color: #9C27B0; }
        .contact-card.escalation { border-left-color: var(--red); }
        .contact-card .role-label {
            font-size: 0.7em;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .contact-card.dispatch .role-label { color: var(--orange-primary); }
        .contact-card.priority .role-label { color: #2196F3; }
        .contact-card.back-up .role-label { color: #9C27B0; }
        .contact-card.escalation .role-label { color: var(--red); }
        .contact-card .contact-name {
            font-size: 1.05em;
            font-weight: 600;
            color: var(--grey-800);
            margin-bottom: 2px;
        }
        .contact-card .contact-position {
            font-size: 0.85em;
            color: var(--grey-500);
            margin-bottom: 8px;
        }
        .contact-card .contact-detail {
            font-size: 0.85em;
            color: var(--grey-700);
            margin-bottom: 3px;
        }
        .contact-card .contact-detail a {
            color: var(--orange-primary);
            text-decoration: none;
        }
        .contact-card .contact-detail a:hover { text-decoration: underline; }

        /* General/capabilities section */
        .capabilities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .cap-item {
            background: var(--grey-50);
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cap-item .cap-label {
            font-size: 0.85em;
            color: var(--grey-600);
        }
        .cap-item .cap-value {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--grey-800);
        }
        .cap-yes { color: var(--green) !important; }
        .cap-no { color: var(--red) !important; }

        /* No results / loading */
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--grey-400);
        }
        .no-results h2 { color: var(--orange-primary); margin-bottom: 12px; }
        .loading { text-align: center; padding: 60px; color: var(--grey-400); font-size: 1.1em; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px;
        }
        .pagination button {
            padding: 8px 16px;
            border: 1px solid var(--grey-200);
            background: var(--white);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .pagination button:hover:not(:disabled) {
            background: var(--orange-light);
            border-color: var(--orange-primary);
        }
        .pagination button:disabled {
            opacity: 0.4;
            cursor: default;
        }
        .pagination .page-info {
            font-size: 0.85em;
            color: var(--grey-500);
        }

        /* FSC Banner */
        .fsc-banner {
            padding: 8px 40px;
            background: var(--grey-800);
            color: var(--grey-300);
            font-size: 0.78em;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }
        .fsc-banner .fsc-item span { color: var(--orange-primary); font-weight: 600; }

        /* Footer */
        .footer {
            padding: 16px 40px;
            background: var(--grey-50);
            border-top: 1px solid var(--grey-200);
            text-align: center;
            font-size: 0.78em;
            color: var(--grey-400);
        }

        /* Procurement Rate Calculator */
        #procurementSection {
            padding: 30px 40px;
            background: var(--grey-50);
            border-top: 2px solid var(--grey-200);
        }
        .proc-header {
            margin-bottom: 24px;
        }
        .proc-header h2 {
            font-size: 1.3em;
            color: var(--orange-primary);
            margin-bottom: 8px;
        }
        .proc-header p {
            font-size: 0.95em;
            color: var(--grey-500);
            margin: 0;
        }
        .proc-form {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
            margin-bottom: 24px;
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--grey-200);
        }
        .proc-form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .proc-form-group label {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--grey-500);
        }
        .proc-form-group input,
        .proc-form-group select {
            padding: 10px 14px;
            font-size: 0.95em;
            border: 2px solid var(--grey-200);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: var(--white);
        }
        .proc-form-group input:focus,
        .proc-form-group select:focus {
            border-color: var(--orange-primary);
            box-shadow: 0 0 0 3px rgba(255,140,0,0.15);
        }
        #proc_location { width: 220px; }
        #proc_override { width: 420px; min-width: 300px; }
        .proc-status {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            background: var(--orange-light);
            border: 2px solid var(--orange-primary);
            border-radius: 8px;
            font-weight: 600;
            color: var(--grey-800);
            font-size: 0.95em;
        }
        .proc-status.active { display: flex; }
        .proc-spinner {
            width: 20px; height: 20px;
            border: 3px solid var(--grey-200);
            border-top-color: var(--orange-primary);
            border-radius: 50%;
            animation: proc-spin 0.8s linear infinite;
        }
        @keyframes proc-spin { to { transform: rotate(360deg); } }
        .proc-btn-group {
            display: flex;
            gap: 8px;
        }
        .proc-btn-group .btn {
            padding: 10px 20px;
            font-size: 0.95em;
        }
        .proc-result {
            background: var(--white);
            border: 1px solid var(--grey-200);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        .proc-result-header {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--orange-primary);
            margin-bottom: 16px;
            border-bottom: 2px solid var(--grey-200);
            padding-bottom: 12px;
        }
        .proc-result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--grey-100);
        }
        .proc-result-row:last-child {
            border-bottom: none;
        }
        .proc-result-label {
            font-weight: 600;
            color: var(--grey-700);
            min-width: 150px;
        }
        .proc-result-value {
            text-align: right;
            color: var(--grey-800);
            font-weight: 500;
        }
        .proc-cost {
            font-size: 1.3em;
            color: var(--orange-primary);
            font-weight: 700;
        }
        #proc_map {
            height: 300px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--grey-200);
        }
        .proc-accessorials {
            background: var(--grey-50);
            border: 1px solid var(--grey-200);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .proc-accessorials h3 {
            font-size: 0.95em;
            color: var(--orange-primary);
            margin-bottom: 12px;
            font-weight: 600;
        }
        .proc-accessorial-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.9em;
        }
        .proc-accessorial-item:last-child {
            border-bottom: none;
        }
        .proc-diagnostics {
            background: var(--grey-50);
            border: 1px solid var(--grey-200);
            border-radius: 8px;
            overflow: hidden;
        }
        .proc-diag-header {
            padding: 12px 16px;
            background: var(--grey-200);
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .proc-diag-header:hover {
            background: var(--grey-300);
        }
        .proc-diag-content {
            padding: 16px;
            display: none;
            font-size: 0.85em;
            color: var(--grey-600);
            line-height: 1.6;
        }
        .proc-diag-content.show {
            display: block;
        }
        .proc-disclaimer {
            background: #fff3e0;
            border-left: 4px solid var(--orange-primary);
            padding: 16px;
            border-radius: 4px;
            font-size: 0.85em;
            color: var(--grey-700);
            margin-top: 20px;
        }
        .proc-error {
            color: var(--red);
            font-weight: 500;
            padding: 12px;
            background: #f8d7da;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        /* ============================================================
           COMPARE FEATURE
           ============================================================ */

        /* Compare checkbox in table */
        .compare-cb-cell {
            text-align: center;
            width: 50px;
        }
        .compare-cb-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--orange-primary);
            cursor: pointer;
        }
        .compare-cb-cell input[type="checkbox"]:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        th.compare-th {
            width: 50px;
            text-align: center;
            cursor: default !important;
        }
        th.compare-th:hover {
            background: linear-gradient(135deg, var(--grey-700) 0%, var(--grey-800) 100%) !important;
        }

        /* Floating Action Button */
        .compare-fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            z-index: 1050;
            display: none;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-hover) 100%);
            color: var(--white);
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 24px rgba(255,140,0,0.4);
            transition: all 0.25s;
        }
        .compare-fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 32px rgba(255,140,0,0.5);
        }
        .compare-fab.visible { display: flex; }
        .compare-fab .fab-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            background: var(--white);
            color: var(--orange-primary);
            border-radius: 50%;
            font-size: 0.85em;
            font-weight: 800;
        }

        /* Compare Panel Overlay */
        .compare-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1100;
        }
        .compare-overlay.active { display: block; }

        /* Compare Side Panel */
        .compare-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 560px;
            height: 100%;
            background: var(--white);
            z-index: 1200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -8px 0 30px rgba(0,0,0,0.2);
        }
        .compare-panel.active { transform: translateX(0); }

        .compare-panel-header {
            background: linear-gradient(135deg, var(--grey-800) 0%, var(--grey-900) 100%);
            color: var(--white);
            padding: 18px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .compare-panel-header h2 {
            font-size: 1.15em;
            margin: 0;
        }
        .compare-panel-header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .compare-panel-header .btn-clear {
            padding: 6px 14px;
            font-size: 0.8em;
            background: rgba(255,255,255,0.15);
            color: var(--white);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .compare-panel-header .btn-clear:hover { background: rgba(255,255,255,0.25); }
        .compare-panel-close {
            background: rgba(255,255,255,0.15);
            border: none;
            color: var(--white);
            font-size: 1.4em;
            cursor: pointer;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .compare-panel-close:hover { background: rgba(255,255,255,0.3); }

        .compare-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
        }

        /* Vendor Cards */
        .compare-vendors {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .compare-vendor-card {
            flex: 1;
            min-width: 120px;
            background: var(--grey-50);
            border-radius: 10px;
            padding: 12px 14px;
            border-left: 4px solid var(--orange-primary);
            position: relative;
        }
        .compare-vendor-card .cv-supplier {
            font-weight: 700;
            font-size: 0.85em;
            color: var(--grey-800);
            margin-bottom: 2px;
            padding-right: 24px;
            word-break: break-word;
        }
        .compare-vendor-card .cv-lane {
            font-size: 0.75em;
            color: var(--grey-500);
            margin-bottom: 6px;
        }
        .compare-vendor-card .cv-rate {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--orange-primary);
        }
        .compare-vendor-card .cv-rate-label {
            font-size: 0.7em;
            color: var(--grey-500);
            text-transform: uppercase;
        }
        .compare-vendor-card .cv-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--grey-400);
            font-size: 1.1em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .compare-vendor-card .cv-remove:hover { color: var(--red); }

        /* Vendor color coding (up to 4) */
        .compare-vendor-card:nth-child(1) { border-left-color: var(--orange-primary); }
        .compare-vendor-card:nth-child(2) { border-left-color: #2196F3; }
        .compare-vendor-card:nth-child(3) { border-left-color: #9C27B0; }
        .compare-vendor-card:nth-child(4) { border-left-color: #4CAF50; }

        /* Accessorial Grid */
        .compare-acc-section h3 {
            font-size: 0.9em;
            color: var(--grey-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--grey-200);
        }
        .compare-acc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82em;
            margin-bottom: 16px;
        }
        .compare-acc-table th {
            background: var(--grey-700);
            color: var(--white);
            padding: 8px 10px;
            text-align: left;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: default;
            white-space: nowrap;
        }
        .compare-acc-table th:hover { background: var(--grey-700); }
        .compare-acc-table th.vendor-col-header {
            max-width: 90px;
            white-space: normal;
            word-break: break-word;
            text-align: center;
        }
        .compare-acc-table td {
            padding: 7px 10px;
            border-bottom: 1px solid var(--grey-100);
            vertical-align: middle;
        }
        .compare-acc-table tr:hover { background: var(--grey-50); }
        .compare-acc-table tr.checked-row { background: var(--orange-light); }
        .compare-acc-table tr.section-label td {
            background: var(--grey-100);
            font-weight: 700;
            color: var(--grey-700);
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        .compare-acc-table .fee-cb {
            width: 16px;
            height: 16px;
            accent-color: var(--orange-primary);
            cursor: pointer;
        }
        .compare-acc-table .fee-label-cell {
            font-weight: 600;
            color: var(--grey-700);
            white-space: nowrap;
        }
        .compare-acc-table .vendor-val-cell {
            text-align: center;
            min-width: 80px;
        }
        .compare-acc-table .vendor-val-cell .fee-amount {
            font-weight: 600;
            color: var(--grey-800);
        }
        .compare-acc-table .vendor-val-cell .fee-variable {
            font-size: 0.85em;
            color: var(--grey-400);
            font-style: italic;
        }
        .compare-acc-table .vendor-val-cell input[type="number"] {
            width: 80px;
            padding: 4px 6px;
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            font-size: 0.95em;
            text-align: right;
            outline: none;
        }
        .compare-acc-table .vendor-val-cell input[type="number"]:focus {
            border-color: var(--orange-primary);
            box-shadow: 0 0 0 2px rgba(255,140,0,0.15);
        }
        .compare-acc-table .vendor-val-cell .fee-na {
            color: var(--grey-300);
            font-size: 0.9em;
        }

        /* Custom charge row */
        .compare-add-custom {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .compare-add-custom button {
            padding: 6px 14px;
            font-size: 0.82em;
            background: var(--grey-100);
            border: 1px dashed var(--grey-300);
            border-radius: 6px;
            cursor: pointer;
            color: var(--grey-600);
            font-weight: 600;
            transition: all 0.2s;
        }
        .compare-add-custom button:hover {
            background: var(--orange-light);
            border-color: var(--orange-primary);
            color: var(--orange-primary);
        }
        .custom-label-input {
            width: 130px;
            padding: 4px 8px;
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            font-size: 0.9em;
            outline: none;
        }
        .custom-label-input:focus {
            border-color: var(--orange-primary);
        }

        /* Totals */
        .compare-totals {
            background: var(--grey-50);
            border-radius: 10px;
            padding: 16px;
            margin-top: 8px;
        }
        .compare-totals h3 {
            font-size: 0.9em;
            color: var(--grey-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }
        .compare-totals-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .compare-total-card {
            flex: 1;
            min-width: 110px;
            background: var(--white);
            border-radius: 8px;
            padding: 14px;
            text-align: center;
            border: 2px solid var(--grey-200);
            transition: border-color 0.2s;
        }
        .compare-total-card.best { border-color: #4CAF50; background: #f1f8e9; }
        .compare-total-card.worst { border-color: var(--red); background: #fce4ec; }
        .compare-total-card .ct-vendor {
            font-size: 0.78em;
            font-weight: 700;
            color: var(--grey-600);
            margin-bottom: 4px;
            word-break: break-word;
        }
        .compare-total-card .ct-base {
            font-size: 0.75em;
            color: var(--grey-400);
            margin-bottom: 2px;
        }
        .compare-total-card .ct-acc {
            font-size: 0.75em;
            color: var(--grey-400);
            margin-bottom: 6px;
        }
        .compare-total-card .ct-total {
            font-size: 1.35em;
            font-weight: 800;
            color: var(--grey-800);
        }
        .compare-total-card.best .ct-total { color: #2e7d32; }
        .compare-total-card.worst .ct-total { color: var(--red); }
        .compare-total-card .ct-diff {
            font-size: 0.75em;
            color: var(--grey-400);
            margin-top: 4px;
        }
        .compare-total-card.best .ct-diff { color: #2e7d32; font-weight: 600; }
        .compare-total-card.worst .ct-diff { color: var(--red); }

        .compare-disclaimer {
            margin-top: 16px;
            padding: 12px;
            background: #fff3e0;
            border-left: 3px solid var(--orange-primary);
            border-radius: 4px;
            font-size: 0.78em;
            color: var(--grey-600);
        }

        .compare-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--grey-400);
        }
        .compare-empty p { margin-bottom: 8px; }

        /* Responsive */
        @media (max-width: 900px) {
            .header { flex-direction: column; text-align: center; gap: 12px; }
            .filter-bar { padding: 16px 20px; }
            #searchDest, #searchSupplier, #filterRegion, #filterOrigin { width: 100%; }
            .filter-group { width: 100%; }
            .results-section { padding: 0 8px 16px; }
            .modal-body { padding: 16px; }
            .compare-panel { width: 100%; }
            .compare-fab { bottom: 16px; right: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>K-APEX Rate Management System</h1>
                <p>Drayage Rate Search &amp; Vendor Information</p>
            </div>
            <div class="header-right">
                <div class="stat"><strong id="statRates">-</strong> rates</div>
                <div class="stat"><strong id="statDests">-</strong> destinations</div>
                <div class="stat"><strong id="statVendors">-</strong> vendors</div>
            </div>
        </div>

        <!-- FSC Banner -->
        <div class="fsc-banner" id="fscBanner"></div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group autocomplete-wrapper">
                <label>Destination City</label>
                <input type="text" id="searchDest" placeholder="Search destination..." autocomplete="off">
                <div class="autocomplete-list" id="destAutocomplete"></div>
            </div>
            <div class="filter-group">
                <label>Region</label>
                <select id="filterRegion">
                    <option value="">All Regions</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Origin</label>
                <select id="filterOrigin">
                    <option value="">All Origins</option>
                </select>
            </div>
            <div class="filter-group autocomplete-wrapper">
                <label>Supplier</label>
                <input type="text" id="searchSupplier" placeholder="Search supplier..." autocomplete="off">
                <div class="autocomplete-list" id="supplierAutocomplete"></div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">Search</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
            </div>
        </div>

        <!-- Results Info -->
        <div class="results-info" id="resultsInfo">
            <span>Enter a search term or select filters to find rates.</span>
            <span></span>
        </div>

        <!-- Results Table -->
        <div class="results-section">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th class="compare-th"><span style="font-size:0.9em;">&#9745;</span></th>
                        <th data-col="region" onclick="sortBy('region')">Region <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="origin" onclick="sortBy('origin')">Origin <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="destinationCity" onclick="sortBy('destinationCity')">Destination <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="supplier" onclick="sortBy('supplier')">Supplier <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="baseRate" onclick="sortBy('baseRate')">Base Rate <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="fscPercent" onclick="sortBy('fscPercent')">FSC % <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="baseAndFsc" onclick="sortBy('baseAndFsc')">Base + FSC <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="freeDropPick" onclick="sortBy('freeDropPick')">Free Drop/Pick <span class="sort-arrow">&#9650;</span></th>
                        <th data-col="layoverFee" onclick="sortBy('layoverFee')">Layover <span class="sort-arrow">&#9650;</span></th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination"></div>

        <!-- Procurement Rate Calculator Section -->
        <div id="procurementSection" style="display:none;">
            <div class="proc-header">
                <h2>No Contracted Rates Found</h2>
                <p>Use the Rate Calculator below to estimate pricing based on driving distance:</p>
            </div>

            <!-- Calculator Form -->
            <div class="proc-form">
                <div class="proc-form-group">
                    <label for="proc_location">City/State</label>
                    <input type="text" id="proc_location" placeholder="e.g., Denver, CO">
                </div>
                <div class="proc-form-group">
                    <label for="proc_override">Destination Override</label>
                    <select id="proc_override">
                        <option value="">Auto-select nearest</option>
                    </select>
                </div>
                <div class="proc-btn-group">
                    <button class="btn btn-primary" onclick="proc_calculateRate()">Calculate</button>
                    <button class="btn btn-secondary" onclick="proc_resetForm()">Reset</button>
                    <button class="btn btn-secondary" id="proc_copyBtn" onclick="proc_copySummary()" style="display:none;">Copy Summary</button>
                </div>
            </div>

            <!-- Status Indicator -->
            <div id="proc_status" class="proc-status">
                <div class="proc-spinner"></div>
                <span id="proc_statusText">Calculating...</span>
            </div>

            <!-- Error Display -->
            <div id="proc_error" class="proc-error" style="display:none;"></div>

            <!-- Results Section -->
            <div id="proc_result" style="display:none;">
                <div class="proc-result">
                    <div class="proc-result-header">Rate Calculation Results</div>
                    <div class="proc-result-row">
                        <span class="proc-result-label">Facility</span>
                        <span class="proc-result-value" id="proc_facility">-</span>
                    </div>
                    <div class="proc-result-row">
                        <span class="proc-result-label">Type</span>
                        <span class="proc-result-value" id="proc_type">-</span>
                    </div>
                    <div class="proc-result-row">
                        <span class="proc-result-label">One-Way Miles</span>
                        <span class="proc-result-value" id="proc_oneway">-</span>
                    </div>
                    <div class="proc-result-row">
                        <span class="proc-result-label">Round-Trip Miles</span>
                        <span class="proc-result-value" id="proc_roundtrip">-</span>
                    </div>
                    <div class="proc-result-row" style="padding-top: 16px; padding-bottom: 0;">
                        <span class="proc-result-label" style="font-size: 1.15em;">Estimated Cost</span>
                        <span class="proc-result-value proc-cost" id="proc_cost">-</span>
                    </div>
                </div>

                <!-- Map -->
                <div id="proc_map"></div>

                <!-- Accessorial Charges -->
                <div class="proc-accessorials">
                    <h3>Typical Accessorial Charges (Reference)</h3>
                    <div id="proc_accessorialsContent"></div>
                </div>

                <!-- Diagnostics -->
                <div class="proc-diagnostics">
                    <div class="proc-diag-header" onclick="proc_toggleDiagnostics()">
                        <span>Diagnostics</span>
                        <span id="proc_diagToggle">▼</span>
                    </div>
                    <div class="proc-diag-content" id="proc_diagContent"></div>
                </div>
            </div>

            <!-- Disclaimer -->
            <div class="proc-disclaimer">
                <strong>Important Disclaimer:</strong> Rates displayed are estimates only. Actual pricing may vary based on capacity constraints and availability at the time of shipment. Please contact USA operations with any questions.
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            K-APEX Rate Management System &bull; Rates valid per region-specific contract periods &bull; FSC updated monthly
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">Rate Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Rate Summary -->
                <div class="rate-summary" id="modalSummary"></div>

                <!-- Tabs -->
                <div class="modal-tabs" id="modalTabs">
                    <button class="modal-tab active" onclick="switchTab('accessorials')">Accessorial Charges</button>
                    <button class="modal-tab" onclick="switchTab('contacts')">Contact Information</button>
                    <button class="modal-tab" onclick="switchTab('capabilities')">Vendor Capabilities</button>
                </div>

                <!-- Panels -->
                <div class="modal-panel active" id="panel-accessorials"></div>
                <div class="modal-panel" id="panel-contacts"></div>
                <div class="modal-panel" id="panel-capabilities"></div>
            </div>
        </div>
    </div>

    <!-- Compare FAB Button -->
    <button class="compare-fab" id="compareFab" onclick="openComparePanel()">
        Compare <span class="fab-badge" id="compareFabBadge">0</span>
    </button>

    <!-- Compare Overlay -->
    <div class="compare-overlay" id="compareOverlay" onclick="closeComparePanel()"></div>

    <!-- Compare Side Panel -->
    <div class="compare-panel" id="comparePanel">
        <div class="compare-panel-header">
            <h2>Rate Comparison</h2>
            <div class="compare-panel-header-actions">
                <button class="btn-clear" onclick="clearCompare()">Clear All</button>
                <button class="compare-panel-close" onclick="closeComparePanel()">&times;</button>
            </div>
        </div>
        <div class="compare-panel-body" id="comparePanelBody">
            <!-- Populated dynamically -->
        </div>
    </div>

    <script>
    /* ================================================================
       FUEL SURCHARGE CONFIGURATION
       ================================================================
       UPDATE THESE VALUES MONTHLY from the Fuel PDF.
       Regions match the EIA fuel PDF breakdown exactly.
       All displayed rates are recalculated automatically:
           All-In Rate = Base Rate × (1 + FSC%)
       ================================================================ */
    const FSC_CONFIG = {
        "New England":                  0.375,   // 35.5%  — ME, NH, VT, MA, CT, RI
        "Central Atlantic":             0.365,   // 34.0%  — NY, PA, NJ, DE, MD
        "Lower Atlantic":               0.325,   // 31.0%  — AR, WV, VA, NC, TN, SC, GA, FL
        "Midwest":                      0.330,   // 31.0%  — OH, KY, MI, IN, IL, WI, MN, IA, MO, ND, SD, NE, KS, OK
        "Gulf Coast":                   0.300,   // 28.5%  — AL, MS, LA, TX, NM
        "Rocky Mountain":               0.320,   // 29.0%  — MT, ID, WY, UT, CO
        "West Coast Less California":   0.360,   // 34.5%  — WA, OR, NV, AZ
        "California":                   0.445,   // 42.5%  — CA
    };

    /* ================================================================
       ORIGIN → FUEL REGION MAPPING
       ================================================================
       Maps each pickup origin to the fuel region above.
       When new origins appear in rate cards, add them here.
       ================================================================ */
    const ORIGIN_TO_FUEL_REGION = {
        // California
        "LA/LB Ports":                                          "California",
        "OAKLAND, CA":                                          "California",

        // Gulf Coast  (AL, MS, LA, TX, NM)
        "Dallas BNSF":                                          "Gulf Coast",
        "Dallas UPRR":                                          "Gulf Coast",
        "El Paso/Santa Teresa, NM":                             "Gulf Coast",
        "Houston, TX":                                          "Gulf Coast",
        "MOBILE, AL":                                           "Gulf Coast",
        "New Orleans, LA":                                      "Gulf Coast",

        // Lower Atlantic  (AR, WV, VA, NC, TN, SC, GA, FL)
        "Atlanta, GA - CSX & BNSF":                             "Lower Atlantic",
        "Atlanta, GA - NS Austell":                             "Lower Atlantic",
        "BNSF - Memphis (Shelby)":                              "Lower Atlantic",
        "CHARLOTTE, NC":                                        "Lower Atlantic",
        "CN - Intermodal Gateway Memphis":                      "Lower Atlantic",
        "CSX - Memphis":                                        "Lower Atlantic",
        "Charleston, SC":                                       "Lower Atlantic",
        "GREER, SC":                                            "Lower Atlantic",
        "JACKSONVILLE, FL":                                     "Lower Atlantic",
        "MIAMI, FL":                                            "Lower Atlantic",
        "NASHVILLE, TN":                                        "Lower Atlantic",
        "NORFOLK, VA":                                          "Lower Atlantic",
        "NS - Rossville,TN":                                    "Lower Atlantic",
        "PORT EVERGLADES, FL":                                  "Lower Atlantic",
        "SAVANNAH, GA":                                         "Lower Atlantic",
        "TAMPA, FL":                                            "Lower Atlantic",
        "UP - Marion, AR":                                      "Lower Atlantic",
        "WILMINGTON, NC":                                       "Lower Atlantic",

        // Midwest  (OH, KY, MI, IN, IL, WI, MN, IA, MO, ND, SD, NE, KS, OK)
        "CHICAGO, IL  - UP JOLIET INTERMODAL TERMINAL GLOBAL 4 (I206)": "Midwest",
        "CHICAGO, IL -  NORFOLK SOUTHERN - LANDERS (I104)":     "Midwest",
        "CHICAGO, IL - BNSF - CHICAGO - LPC (H572)":           "Midwest",
        "CHICAGO, IL - CN RAIL - CHICAGO - HARVEY (I092)":      "Midwest",
        "CHICAGO, IL - CP RAIL - CHICAGO, BENSENVILLE (J830)":  "Midwest",
        "CHICAGO, IL - CSX (J470)":                             "Midwest",
        "CINCINNATI, OH":                                       "Midwest",
        "CLEVELAND, OH":                                        "Midwest",
        "COLUMBUS, OH":                                         "Midwest",
        "DETROIT, MI":                                          "Midwest",
        "INDIANAPOLIS, IN":                                     "Midwest",
        "KANSAS CITY, KS - BNSF LOGISTICS PARK":               "Midwest",
        "KANSAS CITY, KS - CPKC - Kansas City / CSX KANSAS CITY": "Midwest",
        "KANSAS CITY, KS - NS VOLTZ / UP NEFF":                "Midwest",
        "LOUISVILLE, KY":                                       "Midwest",
        "MINNEAPOLIS, MN / ST. PAUL, MN":                      "Midwest",
        "OMAHA, NE / COUNCIL BLUFFS, IA":                      "Midwest",
        "ST.LOUIS, MO":                                         "Midwest",

        // New England  (ME, NH, VT, MA, CT, RI)
        "BOSTON, MA":                                            "New England",
        "Worcester, MA":                                        "New England",

        // Central Atlantic  (NY, PA, NJ, DE, MD)
        "NEW YORK, NY":                                         "Central Atlantic",
        "PHILADELPHIA, PA":                                     "Central Atlantic",
        "BALTIMORE, MD":                                        "Central Atlantic",
        "PITTSBURGH, PA":                                       "Central Atlantic",
        "Buffalo, NY":                                          "Central Atlantic",

        // Rocky Mountain  (MT, ID, WY, UT, CO)
        "Denver - BNSF Denver / UP Denver":                     "Rocky Mountain",
        "Denver - BNSF Hudson":                                 "Rocky Mountain",
        "Salt Lake City":                                       "Rocky Mountain",

        // West Coast Less California  (WA, OR, NV, AZ)
        "Seattle WA":                                           "West Coast Less California",
        "Tacoma WA":                                            "West Coast Less California",
        "Portland OR":                                          "West Coast Less California",
    };

    /**
     * Get the FSC percentage for a given origin.
     * Looks up the origin in the mapping, then gets the FSC from config.
     * Falls back to checking if the origin text contains a mapped key.
     */
    function getFscForOrigin(origin) {
        // Direct match
        if (ORIGIN_TO_FUEL_REGION[origin]) {
            return FSC_CONFIG[ORIGIN_TO_FUEL_REGION[origin]] ?? 0;
        }
        // Partial match (for origins not exactly matching the map)
        const originUpper = origin.toUpperCase();
        for (const [mappedOrigin, fuelRegion] of Object.entries(ORIGIN_TO_FUEL_REGION)) {
            if (originUpper.includes(mappedOrigin.toUpperCase()) ||
                mappedOrigin.toUpperCase().includes(originUpper)) {
                return FSC_CONFIG[fuelRegion] ?? 0;
            }
        }
        // Last resort: try to match by the rate card's region name
        return 0;
    }

    /**
     * Recalculate FSC and all-in rate for a single rate record
     * using the current FSC_CONFIG values.
     */
    function recalcRate(rate) {
        const fsc = getFscForOrigin(rate.origin);
        rate.fscPercent = fsc;
        rate.baseAndFsc = rate.baseRate * (1 + fsc);
        return rate;
    }

    /**
     * Recalculate all rates using current FSC_CONFIG.
     * Call this after loading data or after editing FSC_CONFIG.
     */
    function recalcAllRates() {
        ratesData.forEach(recalcRate);
    }

    /* ================================================================
       DATA
       ================================================================ */
    let ratesData = [];
    let contactsData = [];
    let accessorialsData = [];
    let filteredRates = [];
    let currentSort = { col: 'baseAndFsc', dir: 'asc' };
    let currentPage = 1;
    const PAGE_SIZE = 100;

    // Compare feature state
    let compareList = [];       // Array of rate objects added to comparison
    const MAX_COMPARE = 4;
    let customChargeCounter = 0; // Counter for custom charge rows

    /* ================================================================
       INITIALIZATION
       ================================================================ */
    async function init() {
        try {
            const [ratesResp, contactsResp, accResp] = await Promise.all([
                fetch('https://raw.githubusercontent.com/boomervazquez/DrayRMSTEST/main/rates.json'),
                fetch('https://raw.githubusercontent.com/boomervazquez/DrayRMSTEST/main/contacts.json'),
                fetch('https://raw.githubusercontent.com/boomervazquez/DrayRMSTEST/main/accessorials.json')
            ]);

            if (!ratesResp.ok || !contactsResp.ok || !accResp.ok) {
                throw new Error('Failed to load data files. Ensure data/*.json files are present.');
            }

            ratesData = await ratesResp.json();
            contactsData = await contactsResp.json();
            accessorialsData = await accResp.json();

            // Recalculate all rates using current FSC_CONFIG
            recalcAllRates();

            // Populate stats
            const regions = new Set(ratesData.map(r => r.region));
            const destinations = new Set(ratesData.map(r => r.destinationCity));
            const suppliers = new Set(ratesData.map(r => r.supplier));

            document.getElementById('statRates').textContent = ratesData.length.toLocaleString();
            document.getElementById('statDests').textContent = destinations.size.toLocaleString();
            document.getElementById('statVendors').textContent = suppliers.size.toLocaleString();

            // Populate FSC banner
            renderFscBanner();

            // Populate region filter
            const regionSelect = document.getElementById('filterRegion');
            Array.from(regions).sort().forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                regionSelect.appendChild(opt);
            });

            // Populate origin filter
            populateOrigins();

            // Region change updates origins
            regionSelect.addEventListener('change', populateOrigins);

            // Set up autocomplete
            setupAutocomplete('searchDest', 'destAutocomplete', () => {
                return [...new Set(ratesData.map(r => r.destinationCity))].sort();
            });
            setupAutocomplete('searchSupplier', 'supplierAutocomplete', () => {
                return [...new Set(ratesData.map(r => r.supplier))].sort();
            });

            // Enter key triggers search
            document.getElementById('searchDest').addEventListener('keydown', e => {
                if (e.key === 'Enter') applyFilters();
            });
            document.getElementById('searchSupplier').addEventListener('keydown', e => {
                if (e.key === 'Enter') applyFilters();
            });

            // Show welcome state
            document.getElementById('resultsBody').innerHTML = '';

            // Initialize procurement rate calculator
            proc_populateProcOverride();

        } catch (error) {
            console.error('Init error:', error);
            document.getElementById('resultsBody').innerHTML =
                `<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--red);">
                    Error loading data: ${error.message}
                </td></tr>`;
        }
    }

    function renderFscBanner() {
        const banner = document.getElementById('fscBanner');
        // Show FSC_CONFIG fuel regions directly — matches the monthly fuel PDF
        banner.innerHTML = Object.entries(FSC_CONFIG).map(([region, pct]) =>
            `<div class="fsc-item">${region}: <span>${(pct * 100).toFixed(1)}%</span></div>`
        ).join('');
    }

    function populateOrigins() {
        const regionVal = document.getElementById('filterRegion').value;
        const originSelect = document.getElementById('filterOrigin');
        originSelect.innerHTML = '<option value="">All Origins</option>';

        let origins;
        if (regionVal) {
            origins = [...new Set(ratesData.filter(r => r.region === regionVal).map(r => r.origin))].sort();
        } else {
            origins = [...new Set(ratesData.map(r => r.origin))].sort();
        }
        origins.forEach(o => {
            if (!o) return;
            const opt = document.createElement('option');
            opt.value = o;
            opt.textContent = o;
            originSelect.appendChild(opt);
        });
    }

    /* ================================================================
       AUTOCOMPLETE
       ================================================================ */
    function setupAutocomplete(inputId, listId, getItems) {
        const input = document.getElementById(inputId);
        const list = document.getElementById(listId);
        let currentFocus = -1;

        input.addEventListener('input', () => {
            const val = input.value.toLowerCase();
            list.innerHTML = '';
            currentFocus = -1;
            if (!val) return;

            const matches = getItems().filter(item =>
                item.toLowerCase().includes(val)
            ).slice(0, 12);

            matches.forEach(item => {
                const div = document.createElement('div');
                div.textContent = item;
                div.addEventListener('click', () => {
                    input.value = item;
                    list.innerHTML = '';
                    applyFilters();
                });
                list.appendChild(div);
            });
        });

        input.addEventListener('keydown', e => {
            const items = list.querySelectorAll('div');
            if (e.key === 'ArrowDown') {
                currentFocus++;
                setActive(items, currentFocus);
            } else if (e.key === 'ArrowUp') {
                currentFocus--;
                setActive(items, currentFocus);
            } else if (e.key === 'Enter' && currentFocus > -1) {
                e.preventDefault();
                items[currentFocus]?.click();
            }
        });

        function setActive(items, idx) {
            items.forEach(i => i.classList.remove('active'));
            if (idx >= items.length) currentFocus = 0;
            if (idx < 0) currentFocus = items.length - 1;
            items[currentFocus]?.classList.add('active');
        }

        document.addEventListener('click', e => {
            if (e.target !== input) list.innerHTML = '';
        });
    }

    /* ================================================================
       FILTERING & SEARCH
       ================================================================ */
    function applyFilters() {
        const dest = document.getElementById('searchDest').value.trim().toLowerCase();
        const region = document.getElementById('filterRegion').value;
        const origin = document.getElementById('filterOrigin').value;
        const supplier = document.getElementById('searchSupplier').value.trim().toLowerCase();

        // Close autocomplete lists
        document.getElementById('destAutocomplete').innerHTML = '';
        document.getElementById('supplierAutocomplete').innerHTML = '';

        filteredRates = ratesData.filter(r => {
            if (dest && !r.destinationCity.toLowerCase().includes(dest)) return false;
            if (region && r.region !== region) return false;
            if (origin && r.origin !== origin) return false;
            if (supplier && !r.supplier.toLowerCase().includes(supplier)) return false;
            return true;
        });

        // Apply current sort
        sortData();
        currentPage = 1;
        renderResults();
    }

    function clearFilters() {
        document.getElementById('searchDest').value = '';
        document.getElementById('filterRegion').value = '';
        document.getElementById('filterOrigin').value = '';
        document.getElementById('searchSupplier').value = '';
        populateOrigins();
        filteredRates = [];
        document.getElementById('resultsBody').innerHTML = '';
        document.getElementById('resultsInfo').innerHTML =
            '<span>Enter a search term or select filters to find rates.</span><span></span>';
        document.getElementById('pagination').innerHTML = '';
        document.getElementById('procurementSection').style.display = 'none';
    }

    /* ================================================================
       SORTING
       ================================================================ */
    function sortBy(col) {
        if (currentSort.col === col) {
            currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.col = col;
            currentSort.dir = 'asc';
        }

        // Update header indicators
        document.querySelectorAll('th').forEach(th => {
            th.classList.remove('sorted');
            th.querySelector('.sort-arrow').innerHTML = '&#9650;';
        });
        const activeTh = document.querySelector(`th[data-col="${col}"]`);
        if (activeTh) {
            activeTh.classList.add('sorted');
            activeTh.querySelector('.sort-arrow').innerHTML =
                currentSort.dir === 'asc' ? '&#9650;' : '&#9660;';
        }

        sortData();
        renderResults();
    }

    function sortData() {
        const { col, dir } = currentSort;
        filteredRates.sort((a, b) => {
            let va = a[col];
            let vb = b[col];

            // Numeric columns
            if (['baseRate', 'fscPercent', 'baseAndFsc'].includes(col)) {
                va = va ?? Infinity;
                vb = vb ?? Infinity;
                return dir === 'asc' ? va - vb : vb - va;
            }

            // String columns
            va = (va ?? '').toString().toLowerCase();
            vb = (vb ?? '').toString().toLowerCase();
            if (va < vb) return dir === 'asc' ? -1 : 1;
            if (va > vb) return dir === 'asc' ? 1 : -1;
            return 0;
        });
    }

    /* ================================================================
       RENDERING
       ================================================================ */
    function formatCurrency(val) {
        if (val === null || val === undefined || isNaN(val)) return '-';
        return '$' + parseFloat(val).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatPercent(val) {
        if (val === null || val === undefined || isNaN(val)) return '-';
        return (parseFloat(val) * 100).toFixed(1) + '%';
    }

    function yesNoTag(val) {
        const v = (val ?? '').toString().trim().toUpperCase();
        if (v === 'Y' || v === 'YES') return '<span class="tag tag-yes">Yes</span>';
        return '<span class="tag tag-no">No</span>';
    }

    function renderResults() {
        const tbody = document.getElementById('resultsBody');
        const info = document.getElementById('resultsInfo');
        const pag = document.getElementById('pagination');

        if (filteredRates.length === 0) {
            tbody.innerHTML = '';
            info.innerHTML = '<span>No rates found matching your criteria.</span><span></span>';
            pag.innerHTML = '';
            document.getElementById('procurementSection').style.display = 'block';
            // Pre-fill procurement location with search destination
            const destInput = document.getElementById('searchDest').value.trim();
            if (destInput) {
                document.getElementById('proc_location').value = destInput;
            }
            return;
        }

        // Hide procurement section when results are found
        document.getElementById('procurementSection').style.display = 'none';

        const totalPages = Math.ceil(filteredRates.length / PAGE_SIZE);
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = Math.min(start + PAGE_SIZE, filteredRates.length);
        const pageRates = filteredRates.slice(start, end);

        info.innerHTML = `
            <span>Showing <strong>${start + 1}-${end}</strong> of <strong>${filteredRates.length.toLocaleString()}</strong> rates</span>
            <span>Sorted by ${currentSort.col} (${currentSort.dir})</span>
        `;

        tbody.innerHTML = pageRates.map((r, idx) => {
            const globalIdx = start + idx;
            const isInCompare = isRateInCompare(filteredRates[globalIdx]);
            const compareFull = compareList.length >= MAX_COMPARE && !isInCompare;
            return `
            <tr onclick="openModal(${globalIdx})">
                <td class="compare-cb-cell" onclick="event.stopPropagation()">
                    <input type="checkbox" ${isInCompare ? 'checked' : ''} ${compareFull ? 'disabled title="Maximum ' + MAX_COMPARE + ' vendors for comparison"' : ''}
                        onchange="toggleCompare(${globalIdx})"
                    >
                </td>
                <td><span class="region-badge">${r.region}</span></td>
                <td>${r.origin}</td>
                <td>${r.destinationCity}</td>
                <td>${r.supplier}</td>
                <td class="rate-cell">${formatCurrency(r.baseRate)}</td>
                <td>${formatPercent(r.fscPercent)}</td>
                <td class="rate-cell" style="color:var(--orange-primary)">${formatCurrency(r.baseAndFsc)}</td>
                <td>${yesNoTag(r.freeDropPick)}</td>
                <td>${yesNoTag(r.layoverFee)}</td>
            </tr>`;
        }).join('');

        // Pagination
        pag.innerHTML = `
            <button onclick="goPage(1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>
            <button onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>
            <span class="page-info">Page ${currentPage} of ${totalPages}</span>
            <button onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next &rsaquo;</button>
            <button onclick="goPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>
        `;
    }

    function goPage(page) {
        currentPage = page;
        renderResults();
        document.getElementById('resultsTable').scrollIntoView({ behavior: 'smooth' });
    }

    /* ================================================================
       MODAL - Rate Detail
       ================================================================ */
    function openModal(idx) {
        const rate = filteredRates[idx];
        if (!rate) return;

        // Title
        document.getElementById('modalTitle').textContent =
            `${rate.supplier} — ${rate.origin} → ${rate.destinationCity}`;

        // Rate summary
        document.getElementById('modalSummary').innerHTML = `
            <div class="rate-summary-item">
                <div class="label">Region</div>
                <div class="value">${rate.region}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">Origin</div>
                <div class="value">${rate.origin}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">Destination</div>
                <div class="value">${rate.destinationCity}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">Base Rate</div>
                <div class="value">${formatCurrency(rate.baseRate)}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">FSC</div>
                <div class="value">${formatPercent(rate.fscPercent)}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">All-In Rate (Base + FSC)</div>
                <div class="value highlight">${formatCurrency(rate.baseAndFsc)}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">Free Drop/Pick</div>
                <div class="value">${(rate.freeDropPick || 'N').toUpperCase() === 'Y' ? 'Yes' : 'No'}</div>
            </div>
            <div class="rate-summary-item">
                <div class="label">Layover Fee</div>
                <div class="value">${(rate.layoverFee || 'N').toUpperCase() === 'Y' ? 'Yes' : 'No'}</div>
            </div>
        `;

        // Find matching accessorial data
        const acc = findAccessorial(rate.supplier, rate.region);
        renderAccessorialsPanel(acc);

        // Find matching contacts
        const contacts = findContacts(rate.supplier, rate.region);
        renderContactsPanel(contacts);

        // Render capabilities
        renderCapabilitiesPanel(acc);

        // Show modal, default to first tab
        switchTab('accessorials');
        document.getElementById('modalOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(event) {
        if (event && event.target !== document.getElementById('modalOverlay')) return;
        document.getElementById('modalOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }

    // Close on Escape
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }
    });

    function switchTab(tabName) {
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.modal-panel').forEach(p => p.classList.remove('active'));

        const tabs = document.querySelectorAll('.modal-tab');
        const tabMap = { accessorials: 0, contacts: 1, capabilities: 2 };
        tabs[tabMap[tabName]]?.classList.add('active');
        document.getElementById(`panel-${tabName}`).classList.add('active');
    }

    /* ================================================================
       VENDOR MATCHING
       ================================================================ */
    function normalizeVendor(name) {
        if (!name) return '';
        let n = name.trim().toUpperCase();
        n = n.replace(/,?\s*\bLLC\b\.?/g, '');
        n = n.replace(/,?\s*\bINC\b\.?/g, '');
        n = n.replace(/,?\s*\bCORP\b\.?/g, '');
        n = n.replace(/,?\s*\bLTD\b\.?/g, '');
        n = n.replace(/,?\s*\bCO\b\./g, '');
        n = n.replace(/\s*\(.*?\)/g, '');
        n = n.replace(/[^A-Z0-9 ]/g, ' ');
        n = n.replace(/\s+/g, ' ').trim();
        return n;
    }

    function normalizeVendorNospace(name) {
        return normalizeVendor(name).replace(/[^A-Z0-9]/g, '');
    }

    function findAccessorial(supplierName, region) {
        const normSupplier = normalizeVendor(supplierName);
        const nsSupplier = normalizeVendorNospace(supplierName);

        // First try exact region + normalized name match
        let match = accessorialsData.find(a =>
            a.region === region &&
            (normalizeVendor(a.vendor) === normSupplier ||
             (a.vendorNospace || normalizeVendorNospace(a.vendor)) === nsSupplier)
        );

        // Try substring matching
        if (!match) {
            match = accessorialsData.find(a => {
                if (a.region !== region) return false;
                const av = normalizeVendor(a.vendor);
                const avns = a.vendorNospace || normalizeVendorNospace(a.vendor);
                return av.includes(normSupplier) || normSupplier.includes(av) ||
                       avns.includes(nsSupplier) || nsSupplier.includes(avns);
            });
        }

        return match;
    }

    function findContacts(supplierName, region) {
        const normSupplier = normalizeVendor(supplierName);
        const nsSupplier = normalizeVendorNospace(supplierName);

        return contactsData.filter(c => {
            if (c.region !== region) return false;
            const cv = normalizeVendor(c.company);
            const cvns = normalizeVendorNospace(c.company);
            return cv === normSupplier ||
                   cvns === nsSupplier ||
                   cv.includes(normSupplier) || normSupplier.includes(cv) ||
                   cvns.includes(nsSupplier) || nsSupplier.includes(cvns);
        });
    }

    /* ================================================================
       MODAL PANELS
       ================================================================ */
    function renderAccessorialsPanel(acc) {
        const panel = document.getElementById('panel-accessorials');

        if (!acc || !acc.fees || Object.keys(acc.fees).length === 0) {
            panel.innerHTML = '<p style="color:var(--grey-400);padding:20px;text-align:center;">No accessorial charge data available for this vendor in this region.</p>';
            return;
        }

        const fees = acc.fees;
        const comments = acc.comments || {};
        const feeLabels = {
            yardStorageFreeTime: 'Yard Storage Free Time (24hr periods)',
            yardStorageCost: 'Yard Storage Cost (per 24hr)',
            warehouseWaitFreeTime: 'Warehouse Wait Free Time (hours)',
            warehouseWaitFee: 'Warehouse Wait Fee (per hour)',
            prePull: 'Pre-Pull (incl. first 24hrs yard storage)',
            hazmatFee: 'HAZMAT / DG Fee',
            reeferFee: 'Reefer Fee',
            chassisFee: 'Chassis Fee (per day)',
            chassisSplitFee: 'Chassis Split Fee (incl. fuel)',
            triaxleFee: 'Triaxle Fee',
            overweightFee: 'Overweight Fee',
            dryRunFee: 'Dry Run Fee (incl. fuel)',
            stopOffFee: 'Stop Off Fee (incl. fuel)',
            dropPickFee: 'Drop & Pick Fee (incl. bobtail)',
            layoverFee: 'Layover Fee (incl. fuel)',
            bondedFee: 'Bonded Fee',
            residentialDeliveryFee: 'Residential Delivery Fee',
        };

        // Check if any comments exist to decide whether to show column
        const hasAnyComments = Object.keys(comments).some(k =>
            k in feeLabels || ['yardStorageFreeTime','yardStorageCost','warehouseWaitFreeTime','warehouseWaitFee'].includes(k)
        );
        const colSpan = hasAnyComments ? 3 : 2;

        let html = `<table class="acc-table"><thead><tr><th>Charge</th><th>Rate / Terms</th>${hasAnyComments ? '<th>Comments</th>' : ''}</tr></thead><tbody>`;

        function feeRow(key) {
            const val = fees[key] ?? '-';
            const comment = comments[key] || '';
            return `<tr>
                <td>${feeLabels[key]}</td>
                <td><strong>${formatFeeValue(val)}</strong></td>
                ${hasAnyComments ? `<td style="font-style:italic;color:var(--grey-500);font-size:0.9em;">${comment}</td>` : ''}
            </tr>`;
        }

        // Free Time section
        html += `<tr class="section-label"><td colspan="${colSpan}">Free Time</td></tr>`;
        ['yardStorageFreeTime', 'yardStorageCost', 'warehouseWaitFreeTime', 'warehouseWaitFee'].forEach(key => {
            html += feeRow(key);
        });

        // Fees section
        html += `<tr class="section-label"><td colspan="${colSpan}">Fees</td></tr>`;
        ['prePull', 'hazmatFee', 'reeferFee', 'chassisFee', 'chassisSplitFee', 'triaxleFee',
         'overweightFee', 'dryRunFee', 'stopOffFee', 'dropPickFee', 'layoverFee', 'bondedFee',
         'residentialDeliveryFee'].forEach(key => {
            html += feeRow(key);
        });

        html += '</tbody></table>';
        panel.innerHTML = html;
    }

    function formatFeeValue(val) {
        if (!val || val === '-' || val === 'None') return '-';
        const num = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
        if (!isNaN(num) && String(val).match(/^[\$\s]*[\d,.]+\s*$/)) {
            return '$' + num.toFixed(2);
        }
        return val;
    }

    function renderContactsPanel(contacts) {
        const panel = document.getElementById('panel-contacts');

        if (!contacts || contacts.length === 0) {
            panel.innerHTML = '<p style="color:var(--grey-400);padding:20px;text-align:center;">No contact information available for this vendor in this region.</p>';
            return;
        }

        // Order by role
        const roleOrder = { 'Dispatch': 0, 'Priority': 1, 'Back-up': 2, 'Escalation': 3 };
        contacts.sort((a, b) => (roleOrder[a.role] ?? 99) - (roleOrder[b.role] ?? 99));

        const html = '<div class="contact-cards">' + contacts.map(c => {
            const roleClass = (c.role || '').toLowerCase().replace(/[^a-z-]/g, '');
            return `
                <div class="contact-card ${roleClass}">
                    <div class="role-label">${c.role || 'Contact'}</div>
                    <div class="contact-name">${c.contactName || '-'}</div>
                    <div class="contact-position">${c.position || ''}</div>
                    ${c.email ? `<div class="contact-detail">Email: <a href="mailto:${c.email}">${c.email}</a></div>` : ''}
                    ${c.phone ? `<div class="contact-detail">Phone: <a href="tel:${c.phone}">${c.phone}</a></div>` : ''}
                    ${c.pickupTerminal ? `<div class="contact-detail">Terminal: ${c.pickupTerminal}</div>` : ''}
                    ${c.remarks ? `<div class="contact-detail" style="margin-top:6px;font-style:italic;color:var(--grey-400);">${c.remarks}</div>` : ''}
                </div>
            `;
        }).join('') + '</div>';

        panel.innerHTML = html;
    }

    function renderCapabilitiesPanel(acc) {
        const panel = document.getElementById('panel-capabilities');

        if (!acc || !acc.general || Object.keys(acc.general).length === 0) {
            panel.innerHTML = '<p style="color:var(--grey-400);padding:20px;text-align:center;">No vendor capability data available.</p>';
            return;
        }

        const gen = acc.general;
        const comments = acc.comments || {};
        const capLabels = {
            tracking: 'Provides Tracking',
            trackingSystem: 'Tracking System',
            trackingAccuracy: 'Tracking Accuracy',
            willingToUseOurTracking: 'Will Use Our Tracking',
            hazmatCapable: 'HAZMAT / DG Capable',
            assetVehicles: 'Asset Vehicles in Area',
            leasedChassis: 'Leased/Owned Chassis',
            insuranceCoverage: '$1M+ Insurance',
            bondedService: 'Bonded Service',
        };

        function capClass(val) {
            const v = (val ?? '').toString().trim().toLowerCase();
            if (v === 'yes' || v === 'true') return 'cap-yes';
            if (v === 'no' || v === 'false') return 'cap-no';
            return '';
        }

        const html = '<div class="capabilities-grid">' +
            Object.entries(capLabels).map(([key, label]) => {
                const val = gen[key] ?? '-';
                const comment = comments[key] || '';
                return `
                    <div class="cap-item" style="flex-direction:column;align-items:flex-start;">
                        <div style="display:flex;justify-content:space-between;width:100%;align-items:center;">
                            <span class="cap-label">${label}</span>
                            <span class="cap-value ${capClass(val)}">${val}</span>
                        </div>
                        ${comment ? `<div style="font-size:0.78em;font-style:italic;color:var(--grey-400);margin-top:4px;width:100%;">${comment}</div>` : ''}
                    </div>
                `;
            }).join('') + '</div>';

        panel.innerHTML = html;
    }

    /* ================================================================
       PROCUREMENT RATE CALCULATOR
       ================================================================ */

    // Destinations array
    const PROC_DESTINATIONS = [
        {name:"ATLANTA, GA - CSX & BNSF", type:"IPI", lat:33.545109, lon:-84.609939},
        {name:"CHICAGO, IL - CN RAIL - CHICAGO - HARVEY (I092)", type:"IPI", lat:41.582582, lon:-87.646201},
        {name:"MEMPHIS, TN - CN - INTERMODAL GATEWAY MEMPHIS", type:"IPI", lat:35.031884, lon:-90.151894},
        {name:"MEMPHIS, TN - CSX - MEMPHIS", type:"IPI", lat:35.031884, lon:-90.151894},
        {name:"CHICAGO, IL - CP RAIL - CHICAGO, BENSENVILLE (J830)", type:"IPI", lat:41.941386, lon:-87.894674},
        {name:"CHICAGO, IL - BNSF - CHICAGO - LPC (H572)", type:"IPI", lat:41.393772, lon:-88.152065},
        {name:"CHICAGO, IL  - UP JOLIET INTERMODAL TERMINAL GLOBAL 4 (I206)", type:"IPI", lat:41.458470, lon:-88.118630},
        {name:"ATLANTA, GA - NS AUSTELL", type:"IPI", lat:33.822647, lon:-84.651274},
        {name:"CHICAGO, IL -  NORFOLK SOUTHERN - LANDERS (I104)", type:"IPI", lat:41.756107, lon:-87.683117},
        {name:"CHICAGO, IL - CSX (J470)", type:"IPI", lat:41.762825, lon:-87.799362},
        {name:"MEMPHIS, TN - UP - MARION, AR", type:"IPI", lat:35.191874, lon:-90.257432},
        {name:"HOUSTON, TX - HOUSTON PORT", type:"PORT", lat:29.673630, lon:-95.006670},
        {name:"DETROIT, MI", type:"IPI", lat:42.316722, lon:-83.133398},
        {name:"CINCINNATI, OH", type:"IPI", lat:39.121175, lon:-84.537791},
        {name:"KANSAS CITY, KS - CPKC - KANSAS CITY / CSX KANSAS CITY", type:"IPI", lat:38.859078, lon:-94.559678},
        {name:"MEMPHIS, TN - BNSF - MEMPHIS (SHELBY)", type:"IPI", lat:35.023622, lon:-89.900600},
        {name:"NEW YORK, NY", type:"PORT", lat:40.668837, lon:-74.156747},
        {name:"LA/LB, CA PORTS", type:"PORT", lat:33.782664, lon:-118.217784},
        {name:"KANSAS CITY, KS - NS VOLTZ / UP NEFF", type:"IPI", lat:39.181953, lon:-94.427906},
        {name:"MEMPHIS, TN - NS - ROSSVILLE,TN", type:"IPI", lat:35.005260, lon:-89.578705},
        {name:"KANSAS CITY, KS - BNSF LOGISTICS PARK", type:"IPI", lat:38.767739, lon:-94.984948},
        {name:"DALLAS UPRR", type:"IPI", lat:32.628501, lon:-96.680962},
        {name:"COLUMBUS, OH", type:"IPI", lat:39.995573, lon:-82.828357},
        {name:"LOUISVILLE, KY", type:"IPI", lat:38.114500, lon:-85.759700},
        {name:"OMAHA, NE / COUNCIL BLUFFS, IA", type:"IPI", lat:41.216343, lon:-95.929840},
        {name:"SAVANNAH, GA", type:"PORT", lat:32.127400, lon:-81.163200},
        {name:"CHARLOTTE, NC", type:"IPI", lat:35.272334, lon:-80.908698},
        {name:"DALLAS BNSF", type:"IPI", lat:32.964963, lon:-97.327672},
        {name:"ST.LOUIS, MO", type:"IPI", lat:38.601750, lon:-90.315587},
        {name:"NASHVILLE, TN", type:"IPI", lat:36.101542, lon:-86.756239},
        {name:"NEW ORLEANS, LA", type:"IPI", lat:29.915698, lon:-90.101184},
        {name:"WILMINGTON, NC", type:"PORT", lat:34.192767, lon:-77.945727},
        {name:"NORFOLK, VA", type:"PORT", lat:36.872573, lon:-76.358894},
        {name:"BALTIMORE, MD", type:"PORT", lat:39.258370, lon:-76.537550},
        {name:"OAKLAND, CA", type:"PORT", lat:37.796856, lon:-122.304260},
        {name:"CHARLESTON, SC", type:"PORT", lat:32.840553, lon:-79.953115},
        {name:"BOSTON, MA", type:"PORT", lat:42.339765, lon:-71.035435},
        {name:"SALT LAKE CITY, UT", type:"IPI", lat:40.771550, lon:-111.907986},
        {name:"CLEVELAND, OH", type:"IPI", lat:41.563840, lon:-81.575457},
        {name:"MOBILE, AL", type:"PORT", lat:30.666587, lon:-88.041873},
        {name:"GREER, SC", type:"IPI", lat:34.930864, lon:-82.192319},
        {name:"JACKSONVILLE, FL", type:"PORT", lat:30.394677, lon:-81.540770},
        {name:"MINNEAPOLIS, MN / ST. PAUL, MN", type:"IPI", lat:44.968859, lon:-93.172196},
        {name:"TAMPA, FL", type:"PORT", lat:27.919242, lon:-82.431773},
        {name:"MIAMI, FL", type:"PORT", lat:25.771817, lon:-80.165674},
        {name:"PORTLAND OR", type:"PORT", lat:45.638177, lon:-122.750626},
        {name:"PORT EVERGLADES, FL", type:"PORT", lat:26.081660, lon:-80.120584},
        {name:"SEATTLE WA", type:"PORT", lat:47.573856, lon:-122.348359},
        {name:"TACOMA WA", type:"PORT", lat:47.266552, lon:-122.410226},
        {name:"PITTSBURGH, PA", type:"IPI", lat:40.312725, lon:-79.900495},
        {name:"DENVER - BNSF DENVER / UP DENVER", type:"IPI", lat:39.790500, lon:-104.994500},
        {name:"DENVER - BNSF HUDSON", type:"IPI", lat:40.067600, lon:-104.628800},
        {name:"INDIANAPOLIS, IN", type:"IPI", lat:39.746623, lon:-86.164181},
        {name:"BUFFALO, NY", type:"IPI", lat:42.797787, lon:-78.834263},
        {name:"PHILADELPHIA, PA", type:"PORT", lat:39.900862, lon:-75.116517},
        {name:"WORCESTER, MA", type:"IPI", lat:42.224400, lon:-71.790708},
        {name:"EL PASO/SANTA TERESA, NM", type:"IPI", lat:31.752711, lon:-106.493000}
    ];

    // RPM by location
    const PROC_RPM_BY_LOCATION = {
        "ATLANTA, GA - CSX & BNSF": 3.0,
        "ATLANTA, GA - NS AUSTELL": 3.0,
        "BALTIMORE, MD": 3.5,
        "BOSTON, MA": 3.5,
        "BUFFALO, NY": 5.0,
        "CHARLESTON, SC": 3.0,
        "CHARLOTTE, NC": 3.0,
        "CHICAGO, IL  - UP JOLIET INTERMODAL TERMINAL GLOBAL 4 (I206)": 3.0,
        "CHICAGO, IL -  NORFOLK SOUTHERN - LANDERS (I104)": 3.0,
        "CHICAGO, IL - BNSF - CHICAGO - LPC (H572)": 3.0,
        "CHICAGO, IL - CN RAIL - CHICAGO - HARVEY (I092)": 3.0,
        "CHICAGO, IL - CP RAIL - CHICAGO, BENSENVILLE (J830)": 3.0,
        "CHICAGO, IL - CSX (J470)": 3.0,
        "CINCINNATI, OH": 3.0,
        "CLEVELAND, OH": 3.0,
        "COLUMBUS, OH": 3.0,
        "DALLAS BNSF": 3.0,
        "DALLAS UPRR": 3.0,
        "DENVER - BNSF DENVER / UP DENVER": 5.0,
        "DENVER - BNSF HUDSON": 5.0,
        "DETROIT, MI": 3.0,
        "EL PASO/SANTA TERESA, NM": 5.0,
        "GREER, SC": 3.0,
        "HOUSTON, TX - HOUSTON PORT": 3.0,
        "INDIANAPOLIS, IN": 5.0,
        "JACKSONVILLE, FL": 3.0,
        "KANSAS CITY, KS - BNSF LOGISTICS PARK": 3.0,
        "KANSAS CITY, KS - CPKC - KANSAS CITY / CSX KANSAS CITY": 3.0,
        "KANSAS CITY, KS - NS VOLTZ / UP NEFF": 3.0,
        "LA/LB, CA PORTS": 3.25,
        "LOUISVILLE, KY": 3.0,
        "MEMPHIS, TN - BNSF - MEMPHIS (SHELBY)": 3.0,
        "MEMPHIS, TN - CN - INTERMODAL GATEWAY MEMPHIS": 3.0,
        "MEMPHIS, TN - CSX - MEMPHIS": 3.0,
        "MEMPHIS, TN - NS - ROSSVILLE,TN": 3.0,
        "MEMPHIS, TN - UP - MARION, AR": 3.0,
        "MIAMI, FL": 4.0,
        "MINNEAPOLIS, MN / ST. PAUL, MN": 3.0,
        "MOBILE, AL": 3.0,
        "NASHVILLE, TN": 3.0,
        "NEW ORLEANS, LA": 3.25,
        "NEW YORK, NY": 4.0,
        "NORFOLK, VA": 3.0,
        "OAKLAND, CA": 3.5,
        "OMAHA, NE / COUNCIL BLUFFS, IA": 3.0,
        "PHILADELPHIA, PA": 5.0,
        "PITTSBURGH, PA": 5.0,
        "PORT EVERGLADES, FL": 5.0,
        "PORTLAND OR": 3.5,
        "SALT LAKE CITY, UT": 3.0,
        "SAVANNAH, GA": 3.0,
        "SEATTLE WA": 3.25,
        "ST.LOUIS, MO": 3.0,
        "TACOMA WA": 3.0,
        "TAMPA, FL": 3.0,
        "WILMINGTON, NC": 3.0,
        "WORCESTER, MA": 5.0
    };

    let proc_map = null;
    let proc_routeFeatures = null;
    let proc_lastResult = null;

    function proc_normName(s) {
        if (!s) return '';
        let t = String(s).toUpperCase().trim().replace(/\s+/g, ' ');
        t = t.replace(/[.]/g, ' ').replace(/[^A-Z0-9,&\s\-]/g, '').replace(/\s{2,}/g, ' ').trim();
        t = t.replace(/\bPORT OF\s+/g, '');
        t = t.replace(/\bBNSF\b|\bUP\b|\bNS\b|\bCSX\b|\bCP\b|\bCN\b/g, '').replace(/\s{2,}/g,' ').trim();
        const dash = t.indexOf(' - ');
        if (dash > -1) t = t.slice(0, dash).trim();
        t = t.replace(/,?\s+(TERMINAL|RAMP|RAIL|YARD|GATE|PORT|RDC)$/g, '').trim();
        return t;
    }

    // Build normalized RPM lookup map
    const PROC_RPM_NORM_MAP = (() => {
        const out = {};
        for (const k in PROC_RPM_BY_LOCATION) {
            if (!Object.prototype.hasOwnProperty.call(PROC_RPM_BY_LOCATION, k)) continue;
            const nk = proc_normName(k);
            if (!(nk in out)) out[nk] = k;
        }
        return out;
    })();

    function proc_extractCityState(input) {
        // Try "City, ST" format first
        const match = input.match(/^([^,]+),\s*([A-Z]{2})\s*$/i);
        if (match) return { city: match[1].trim(), state: match[2].toUpperCase() };
        // If no comma, just treat as city name (user might enter just "Denver")
        const trimmed = input.trim();
        if (trimmed.length > 0) return { city: trimmed, state: '' };
        return null;
    }

    function proc_getRpmFor(destName) {
        // Exact match first
        if (destName && PROC_RPM_BY_LOCATION.hasOwnProperty(destName)) {
            return PROC_RPM_BY_LOCATION[destName];
        }
        // Normalized match
        const norm = proc_normName(destName);
        if (norm && PROC_RPM_NORM_MAP[norm]) {
            return PROC_RPM_BY_LOCATION[PROC_RPM_NORM_MAP[norm]];
        }
        // Substring match
        const up = String(destName || '').toUpperCase();
        for (const k in PROC_RPM_BY_LOCATION) {
            if (!PROC_RPM_BY_LOCATION.hasOwnProperty(k)) continue;
            const uk = k.toUpperCase();
            if (up.includes(uk) || uk.includes(up)) return PROC_RPM_BY_LOCATION[k];
        }
        return 3.0;
    }

    function proc_haversineMiles(lat1, lon1, lat2, lon2) {
        const R = 3959;
        const toRad = Math.PI / 180;
        const dLat = (lat2 - lat1) * toRad;
        const dLon = (lon2 - lon1) * toRad;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1*toRad) * Math.cos(lat2*toRad) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.asin(Math.sqrt(a));
        return R * c;
    }

    async function proc_geocodeUS(city, state) {
        try {
            const cleanQuery = state ? `${city}, ${state}` : city;
            const usBbox = '-125,24,-66,50';
            const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(cleanQuery)}&limit=10&lang=en&bbox=${usBbox}`;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            const resp = await fetch(url, { method: 'GET', mode: 'cors', headers: { 'Accept': 'application/json' }, signal: controller.signal });
            clearTimeout(timeoutId);
            if (!resp.ok) return null;
            const data = await resp.json();
            const features = data?.features || [];
            if (features.length === 0) return null;
            // Exclude business/POI types
            const excludeKeys = ['shop', 'amenity', 'tourism', 'leisure', 'office', 'railway', 'highway', 'landuse', 'building'];
            let usResults = features.filter(f => {
                const props = f.properties || {};
                const country = props.country || '';
                const osmKey = props.osm_key || '';
                const isUS = country === 'United States' || country === 'USA' || country === 'United States of America';
                if (!isUS) return false;
                if (excludeKeys.includes(osmKey)) return false;
                return true;
            });
            // Prioritize by place type
            let first = null;
            if (usResults.length > 0) {
                const typePriority = ['city', 'town', 'village', 'suburb', 'hamlet', 'locality', 'neighbourhood', 'district'];
                for (const type of typePriority) {
                    first = usResults.find(f => f.properties?.osm_value === type || f.properties?.type === type);
                    if (first) break;
                }
                if (!first) first = usResults[0];
            } else {
                first = features[0];
            }
            const coords = first.geometry?.coordinates;
            if (!coords || coords.length < 2) return null;
            const props = first.properties || {};
            const label = [props.name, props.state].filter(Boolean).join(', ') || cleanQuery;
            return { lat: coords[1], lon: coords[0], label };
        } catch (e) {
            console.error('Geocode error:', e);
            return null;
        }
    }

    async function proc_osrmMiles(lat1, lon1, lat2, lon2) {
        try {
            const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;
            const resp = await fetch(url);
            if (!resp.ok) return null;
            const data = await resp.json();
            if (!data.routes || data.routes.length === 0) return null;
            const route = data.routes[0];
            const meters = route.distance;
            const miles = meters / 1609.34;
            const geom = route.geometry;
            return {miles, geom};
        } catch (e) {
            console.error('OSRM error:', e);
            return null;
        }
    }

    function proc_populateProcOverride() {
        const sel = document.getElementById('proc_override');
        if (!sel) return;
        sel.innerHTML = '';
        const autoOpt = document.createElement('option');
        autoOpt.value = '';
        autoOpt.textContent = 'Auto-select nearest';
        sel.appendChild(autoOpt);

        const ports = PROC_DESTINATIONS.filter(d => d.type === 'PORT').sort((a,b) => a.name.localeCompare(b.name));
        const ipis = PROC_DESTINATIONS.filter(d => d.type === 'IPI').sort((a,b) => a.name.localeCompare(b.name));

        const portGroup = document.createElement('optgroup');
        portGroup.label = 'Ocean Ports';
        ports.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.name;
            opt.textContent = d.name;
            portGroup.appendChild(opt);
        });
        sel.appendChild(portGroup);

        const ipiGroup = document.createElement('optgroup');
        ipiGroup.label = 'IPI Rail Depots';
        ipis.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.name;
            opt.textContent = d.name;
            ipiGroup.appendChild(opt);
        });
        sel.appendChild(ipiGroup);
    }

    function proc_locationAccessorials(destName) {
        const base = [
            'Prepull - $150',
            'Yard Storage - $50/day',
            'Chassis Rental - $50/day',
            'Chassis Split - $150',
            '2 Hours free at the Ramp then $80/Hr after',
            '1 Hour free at warehouse then $100/Hr after',
            'Overweight fee - $250',
            'Tri Axle - $150/day',
            'Reefer Fee - $200'
        ];
        // Location-specific extras
        const raw = String(destName || '').toUpperCase();
        if (raw.includes('OAKLAND, CA')) {
            base.push('USOAK Extended Gate Fee - $55');
        }
        if (raw.includes('LA/LB, CA PORTS') || raw.includes('LOS ANGELES') || raw.includes('LONG BEACH')) {
            base.push('Clean Truck Fee - $20');
            base.push('Pierpass - $80');
        }
        return base;
    }

    function proc_renderProcResult(facility, type, oneway, roundtrip, cost, geom, custLat, custLon) {
        proc_lastResult = {facility, type, oneway, roundtrip, cost, geom, custLat, custLon};
        document.getElementById('proc_facility').textContent = facility;
        document.getElementById('proc_type').textContent = type;
        document.getElementById('proc_oneway').textContent = `${oneway.toFixed(1)} mi`;
        document.getElementById('proc_roundtrip').textContent = `${roundtrip.toFixed(1)} mi`;
        document.getElementById('proc_cost').textContent = `$${cost.toLocaleString('en-US', {minimumFractionDigits:0, maximumFractionDigits:0})}`;
        const acc = proc_locationAccessorials(facility);
        const accHtml = acc.map(item =>
            `<div class="proc-accessorial-item"><span>${item}</span></div>`
        ).join('');
        document.getElementById('proc_accessorialsContent').innerHTML = accHtml;
        const diag = `
            <div><strong>Geocoded Location:</strong> ${custLat.toFixed(4)}, ${custLon.toFixed(4)}</div>
            <div><strong>Facility Lat/Lon:</strong> (check facility details)</div>
            <div><strong>One-Way Distance (Driving):</strong> ${oneway.toFixed(1)} miles</div>
            <div><strong>Round-Trip Distance:</strong> ${roundtrip.toFixed(1)} miles</div>
            <div><strong>Rate/Mile:</strong> $${proc_getRpmFor(facility).toFixed(2)}/mile</div>
            <div><strong>Base Cost (250 + RPM × RT):</strong> $${(250 + proc_getRpmFor(facility) * roundtrip).toLocaleString('en-US', {minimumFractionDigits:0, maximumFractionDigits:0})}</div>
            <div><strong>Final Cost (max 350 floor):</strong> $${cost.toLocaleString('en-US', {minimumFractionDigits:0, maximumFractionDigits:0})}</div>
        `;
        document.getElementById('proc_diagContent').innerHTML = diag;
        document.getElementById('proc_result').style.display = 'block';
        document.getElementById('proc_copyBtn').style.display = 'inline-block';
        if (geom && typeof L !== 'undefined') {
            proc_drawMap(custLat, custLon, geom);
        }
    }

    function proc_drawMap(custLat, custLon, geom) {
        if (typeof L === 'undefined') return; // Leaflet not loaded yet
        if (!proc_map) {
            proc_map = L.map('proc_map').setView([custLat, custLon], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 19
            }).addTo(proc_map);
        } else {
            proc_map.setView([custLat, custLon], 6);
            if (proc_routeFeatures) {
                proc_map.removeLayer(proc_routeFeatures);
            }
        }
        if (geom && geom.coordinates && geom.coordinates.length > 0) {
            const routeLinestring = L.geoJSON(geom, {
                style: {color: '#FF8C00', weight: 3, opacity: 0.8}
            }).addTo(proc_map);
            proc_routeFeatures = routeLinestring;
        }
        L.circleMarker([custLat, custLon], {radius: 8, color: '#FF8C00', fill: true, fillColor: '#FF8C00', weight: 2}).addTo(proc_map);
    }

    function proc_setStatus(text) {
        const statusDiv = document.getElementById('proc_status');
        const statusText = document.getElementById('proc_statusText');
        if (text) {
            statusText.textContent = text;
            statusDiv.classList.add('active');
        } else {
            statusDiv.classList.remove('active');
        }
    }

    async function proc_calculateRate() {
        const locInput = document.getElementById('proc_location').value.trim();
        const overrideVal = document.getElementById('proc_override').value.trim();
        const errDiv = document.getElementById('proc_error');
        errDiv.style.display = 'none';
        errDiv.textContent = '';
        document.getElementById('proc_result').style.display = 'none';

        if (!locInput) {
            errDiv.textContent = 'Please enter a city and state (e.g., Denver, CO).';
            errDiv.style.display = 'block';
            return;
        }

        const cs = proc_extractCityState(locInput);
        if (!cs) {
            errDiv.textContent = 'Invalid format. Please enter as: City, ST (e.g., Denver, CO)';
            errDiv.style.display = 'block';
            return;
        }

        try {
            // Step 1: Geocode
            proc_setStatus('Geocoding location...');
            const geoResult = await proc_geocodeUS(cs.city, cs.state);
            if (!geoResult) {
                proc_setStatus(null);
                errDiv.textContent = `Unable to geocode "${locInput}". Please verify the city/state and try again.`;
                errDiv.style.display = 'block';
                return;
            }

            // NYC metro area detection (by name and coordinates)
            const nycMetroNames = ['manhattan', 'brooklyn', 'queens', 'bronx', 'staten island',
                                   'newark', 'jersey city', 'hoboken', 'elizabeth', 'bayonne',
                                   'union city', 'west new york', 'weehawken', 'secaucus', 'kearny'];
            const labelLower = (geoResult.label || '').toLowerCase();
            const isNYCByName = nycMetroNames.some(b => labelLower.includes(b)) ||
                                (labelLower.includes('new york') && labelLower.includes(', ny'));
            const isNYCByCoords = geoResult.lat >= 40.45 && geoResult.lat <= 41.0 &&
                                  geoResult.lon >= -74.35 && geoResult.lon <= -73.65;
            if (isNYCByName || isNYCByCoords) {
                proc_setStatus(null);
                errDiv.textContent = 'NYC Metro area does not follow standard rate formulas. Please reach out to US.KApex.FCL.Trucking@KLN.COM';
                errDiv.style.display = 'block';
                return;
            }

            // Step 2: Find nearest facility
            let selectedDest = null;
            if (overrideVal) {
                proc_setStatus('Using selected destination...');
                selectedDest = PROC_DESTINATIONS.find(d => d.name === overrideVal);
                if (!selectedDest) {
                    proc_setStatus(null);
                    errDiv.textContent = 'Selected destination not found.';
                    errDiv.style.display = 'block';
                    return;
                }
            } else {
                proc_setStatus('Finding nearest facilities...');
                const candidates = PROC_DESTINATIONS.map(d => ({
                    dest: d,
                    airMiles: proc_haversineMiles(geoResult.lat, geoResult.lon, d.lat, d.lon)
                })).sort((a, b) => a.airMiles - b.airMiles).slice(0, 5);

                proc_setStatus(`Routing to ${candidates.length} candidates in parallel...`);
                const routePromises = candidates.map(({dest}) =>
                    proc_osrmMiles(geoResult.lat, geoResult.lon, dest.lat, dest.lon)
                        .then(result => ({dest, result}))
                );
                const routeResults = await Promise.all(routePromises);

                let bestDist = Infinity;
                let bestDest = null;
                for (const {dest, result} of routeResults) {
                    if (!result) continue;
                    if (result.miles < bestDist) {
                        bestDist = result.miles;
                        bestDest = dest;
                    }
                }
                selectedDest = bestDest || candidates[0].dest;
            }

            // Step 3: Calculate final route
            proc_setStatus(`Computing route to ${selectedDest.name.split(' - ')[0]}...`);
            const routeData = await proc_osrmMiles(geoResult.lat, geoResult.lon, selectedDest.lat, selectedDest.lon);
            if (!routeData) {
                proc_setStatus(null);
                errDiv.textContent = 'Unable to calculate driving distance. Please try again.';
                errDiv.style.display = 'block';
                return;
            }

            let oneway = routeData.miles;
            let roundtrip = oneway * 2;

            if (roundtrip > 800) {
                proc_setStatus(null);
                errDiv.textContent = 'Distance is too large (round-trip > 800 mi). Please choose an alternate routing or reach out to US.KApex.FCL.Trucking@KLN.COM';
                errDiv.style.display = 'block';
                proc_renderProcResult(selectedDest.name, selectedDest.type, oneway, roundtrip, 0, routeData.geom, geoResult.lat, geoResult.lon);
                document.getElementById('proc_cost').textContent = 'Over 800mi RT — Contact Operations';
                return;
            }

            const rpm = proc_getRpmFor(selectedDest.name);
            const calculated = 250 + rpm * roundtrip;
            const cost = Math.max(350, calculated);

            proc_setStatus(null);
            proc_renderProcResult(selectedDest.name, selectedDest.type, oneway, roundtrip, cost, routeData.geom, geoResult.lat, geoResult.lon);

        } catch (e) {
            proc_setStatus(null);
            errDiv.textContent = `Error: ${e.message || 'Something went wrong. Please try again.'}`;
            errDiv.style.display = 'block';
            console.error('Procurement calc error:', e);
        }
    }

    function proc_resetForm() {
        document.getElementById('proc_location').value = '';
        document.getElementById('proc_override').value = '';
        document.getElementById('proc_result').style.display = 'none';
        document.getElementById('proc_error').style.display = 'none';
        document.getElementById('proc_copyBtn').style.display = 'none';
        proc_setStatus(null);
        if (proc_map) {
            proc_map.remove();
            proc_map = null;
        }
    }

    function proc_copySummary() {
        if (!proc_lastResult) return;
        const {facility, type, oneway, roundtrip, cost} = proc_lastResult;
        const summary = `Facility: ${facility}\nType: ${type}\nOne-Way Miles: ${oneway.toFixed(1)}\nRound-Trip Miles: ${roundtrip.toFixed(1)}\nEstimated Cost: $${cost.toLocaleString('en-US')}`;
        navigator.clipboard.writeText(summary).then(() => {
            alert('Summary copied to clipboard!');
        });
    }

    function proc_toggleDiagnostics() {
        const content = document.getElementById('proc_diagContent');
        const toggle = document.getElementById('proc_diagToggle');
        content.classList.toggle('show');
        toggle.textContent = content.classList.contains('show') ? '▲' : '▼';
    }

    /* ================================================================
       RATE COMPARISON FEATURE
       ================================================================ */

    /**
     * Unique key for a rate to identify it in the compare list.
     * Uses supplier + origin + destination + baseRate to handle
     * same vendor with different lanes.
     */
    function rateCompareKey(rate) {
        return `${rate.supplier}|${rate.origin}|${rate.destinationCity}|${rate.baseRate}`;
    }

    function isRateInCompare(rate) {
        const key = rateCompareKey(rate);
        return compareList.some(r => rateCompareKey(r) === key);
    }

    function toggleCompare(filteredIdx) {
        const rate = filteredRates[filteredIdx];
        if (!rate) return;

        const key = rateCompareKey(rate);
        const existIdx = compareList.findIndex(r => rateCompareKey(r) === key);

        if (existIdx > -1) {
            compareList.splice(existIdx, 1);
        } else {
            if (compareList.length >= MAX_COMPARE) return;
            compareList.push({ ...rate }); // Clone to avoid mutation
        }

        updateCompareFab();
        renderResults(); // Re-render to update checkbox states

        // If panel is open, refresh it
        if (document.getElementById('comparePanel').classList.contains('active')) {
            renderComparePanel();
        }
    }

    function updateCompareFab() {
        const fab = document.getElementById('compareFab');
        const badge = document.getElementById('compareFabBadge');
        if (compareList.length > 0) {
            fab.classList.add('visible');
            badge.textContent = compareList.length;
        } else {
            fab.classList.remove('visible');
        }
    }

    function openComparePanel() {
        if (compareList.length === 0) return;
        document.getElementById('compareOverlay').classList.add('active');
        document.getElementById('comparePanel').classList.add('active');
        renderComparePanel();
    }

    function closeComparePanel() {
        document.getElementById('compareOverlay').classList.remove('active');
        document.getElementById('comparePanel').classList.remove('active');
    }

    function clearCompare() {
        compareList = [];
        customChargeCounter = 0;
        updateCompareFab();
        closeComparePanel();
        renderResults();
    }

    function removeFromCompare(idx) {
        compareList.splice(idx, 1);
        updateCompareFab();
        if (compareList.length === 0) {
            closeComparePanel();
        } else {
            renderComparePanel();
        }
        renderResults();
    }

    /**
     * Parse a fee string into a numeric amount or flag as variable.
     * Returns { numeric: true, amount: 150 } or { numeric: false, text: "dependent on location" }
     */
    function parseFeeAmount(val) {
        if (!val || val === '-' || val === 'None' || val === 'N/A') {
            return { numeric: false, text: '' };
        }
        const str = String(val).trim();
        // Try to extract a dollar amount from strings like "$150", "$75/HR", "$40/day"
        const match = str.match(/^\$?\s*([\d,]+(?:\.\d+)?)/);
        if (match) {
            const num = parseFloat(match[1].replace(/,/g, ''));
            if (!isNaN(num)) return { numeric: true, amount: num };
        }
        // Check for pure numbers
        const num = parseFloat(str.replace(/[^0-9.-]/g, ''));
        if (!isNaN(num) && str.match(/^[\$\s]*[\d,.]+\s*$/)) {
            return { numeric: true, amount: num };
        }
        return { numeric: false, text: str };
    }

    /**
     * Build the complete comparison panel content.
     */
    function renderComparePanel() {
        const body = document.getElementById('comparePanelBody');

        if (compareList.length === 0) {
            body.innerHTML = '<div class="compare-empty"><p>No vendors selected for comparison.</p><p style="font-size:0.85em;">Use the checkboxes in the results table to add vendors.</p></div>';
            return;
        }

        // Look up accessorial data for each vendor
        const vendorAccData = compareList.map(r => findAccessorial(r.supplier, r.region));

        // Vendor Cards
        let html = '<div class="compare-vendors">';
        compareList.forEach((r, i) => {
            html += `
                <div class="compare-vendor-card">
                    <button class="cv-remove" onclick="removeFromCompare(${i})" title="Remove">&times;</button>
                    <div class="cv-supplier">${r.supplier}</div>
                    <div class="cv-lane">${r.origin} &rarr; ${r.destinationCity}</div>
                    <div class="cv-rate-label">Base + FSC</div>
                    <div class="cv-rate">${formatCurrency(r.baseAndFsc)}</div>
                </div>`;
        });
        html += '</div>';

        // Accessorial Selection Grid
        html += '<div class="compare-acc-section">';
        html += '<h3>Select Accessorial Charges</h3>';

        // The standard fee keys and labels (reusing the same structure from the modal)
        const compareFeeLabels = {
            prePull: 'Pre-Pull',
            hazmatFee: 'HAZMAT / DG',
            reeferFee: 'Reefer Fee',
            chassisFee: 'Chassis Fee',
            chassisSplitFee: 'Chassis Split',
            triaxleFee: 'Triaxle Fee',
            overweightFee: 'Overweight',
            dryRunFee: 'Dry Run',
            stopOffFee: 'Stop Off',
            dropPickFee: 'Drop & Pick',
            layoverFee: 'Layover',
            bondedFee: 'Bonded',
            residentialDeliveryFee: 'Residential Delivery',
        };

        const freeTimeLabels = {
            warehouseWaitFee: 'Warehouse Wait Fee',
            yardStorageCost: 'Yard Storage Cost',
        };

        // Vendor column short names (truncated for table header)
        const vendorShortNames = compareList.map(r => {
            const name = r.supplier;
            return name.length > 18 ? name.substring(0, 16) + '...' : name;
        });

        html += '<table class="compare-acc-table">';
        html += '<thead><tr><th style="width:30px;"></th><th>Charge</th>';
        vendorShortNames.forEach((name, i) => {
            html += `<th class="vendor-col-header" title="${compareList[i].supplier}">${name}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Free Time / Storage section
        html += `<tr class="section-label"><td colspan="${2 + compareList.length}">Storage & Wait Fees</td></tr>`;
        Object.entries(freeTimeLabels).forEach(([key, label]) => {
            html += buildFeeRow(key, label, vendorAccData);
        });

        // Main Fees section
        html += `<tr class="section-label"><td colspan="${2 + compareList.length}">Accessorial Fees</td></tr>`;
        Object.entries(compareFeeLabels).forEach(([key, label]) => {
            html += buildFeeRow(key, label, vendorAccData);
        });

        // Custom charge rows placeholder
        html += `</tbody><tbody id="customChargeRows"></tbody>`;
        html += '</table>';

        // Add Custom Charge button
        html += `<div class="compare-add-custom">
            <button onclick="addCustomCharge()">+ Add Custom Charge</button>
        </div>`;

        html += '</div>'; // end compare-acc-section

        // Totals Section
        html += '<div class="compare-totals" id="compareTotals"></div>';

        // Disclaimer
        html += '<div class="compare-disclaimer"><strong>Note:</strong> Totals include only the accessorial charges you have selected above. Some fees may be per-day, per-hour, or conditional — review the original fee terms for accuracy.</div>';

        body.innerHTML = html;

        // Initial totals calc
        recalcCompareTotals();
    }

    /**
     * Build a single fee row for the comparison table.
     */
    function buildFeeRow(key, label, vendorAccData) {
        let html = `<tr data-fee-key="${key}">`;
        html += `<td><input type="checkbox" class="fee-cb" data-key="${key}" onchange="onFeeCheckChange(this)"></td>`;
        html += `<td class="fee-label-cell">${label}</td>`;

        compareList.forEach((r, i) => {
            const acc = vendorAccData[i];
            const feeVal = acc?.fees?.[key] ?? null;
            const parsed = parseFeeAmount(feeVal);

            html += '<td class="vendor-val-cell">';
            if (parsed.numeric) {
                html += `<span class="fee-amount" data-vendor="${i}" data-key="${key}" data-amount="${parsed.amount}">${formatCurrency(parsed.amount)}</span>`;
            } else if (parsed.text) {
                // Variable/text-based fee — show text + input for estimate
                html += `<div class="fee-variable" title="${parsed.text}">${truncateText(parsed.text, 20)}</div>`;
                html += `<input type="number" placeholder="Est. $" data-vendor="${i}" data-key="${key}" data-type="estimate"
                    oninput="recalcCompareTotals()" step="0.01" min="0" title="Enter your estimate for: ${parsed.text}">`;
            } else {
                // No data
                html += `<span class="fee-na">N/A</span>`;
                html += `<input type="number" placeholder="Custom $" data-vendor="${i}" data-key="${key}" data-type="custom"
                    oninput="recalcCompareTotals()" step="0.01" min="0" style="margin-top:2px;">`;
            }
            html += '</td>';
        });

        html += '</tr>';
        return html;
    }

    function truncateText(text, maxLen) {
        if (text.length <= maxLen) return text;
        return text.substring(0, maxLen - 1) + '...';
    }

    function onFeeCheckChange(cb) {
        const row = cb.closest('tr');
        if (cb.checked) {
            row.classList.add('checked-row');
        } else {
            row.classList.remove('checked-row');
        }
        recalcCompareTotals();
    }

    function addCustomCharge() {
        const tbody = document.getElementById('customChargeRows');
        if (!tbody) return;

        customChargeCounter++;
        const customKey = `custom_${customChargeCounter}`;

        let html = `<tr data-fee-key="${customKey}" class="checked-row">`;
        html += `<td><input type="checkbox" class="fee-cb" data-key="${customKey}" checked onchange="onFeeCheckChange(this)"></td>`;
        html += `<td class="fee-label-cell"><input type="text" class="custom-label-input" placeholder="Charge name..." data-custom-label="${customKey}"></td>`;

        compareList.forEach((r, i) => {
            html += `<td class="vendor-val-cell">
                <input type="number" placeholder="$" data-vendor="${i}" data-key="${customKey}" data-type="custom"
                    oninput="recalcCompareTotals()" step="0.01" min="0">
            </td>`;
        });

        html += '</tr>';
        tbody.insertAdjacentHTML('beforeend', html);
        recalcCompareTotals();
    }

    /**
     * Recalculate and render the totals for all compared vendors.
     */
    function recalcCompareTotals() {
        const totalsDiv = document.getElementById('compareTotals');
        if (!totalsDiv || compareList.length === 0) return;

        // Get all checked fee keys
        const checkedBoxes = document.querySelectorAll('.compare-acc-table .fee-cb:checked, #customChargeRows .fee-cb:checked');
        const checkedKeys = new Set();
        checkedBoxes.forEach(cb => checkedKeys.add(cb.dataset.key));

        // Calculate per-vendor totals
        const vendorTotals = compareList.map((r, i) => {
            let accTotal = 0;
            let hasEstimates = false;

            checkedKeys.forEach(key => {
                // First check for a fixed amount span
                const amountSpan = document.querySelector(`.compare-acc-table span.fee-amount[data-vendor="${i}"][data-key="${key}"], #customChargeRows span.fee-amount[data-vendor="${i}"][data-key="${key}"]`);
                if (amountSpan) {
                    accTotal += parseFloat(amountSpan.dataset.amount) || 0;
                    return;
                }

                // Then check for user-entered estimate/custom input
                const input = document.querySelector(`.compare-acc-table input[type="number"][data-vendor="${i}"][data-key="${key}"], #customChargeRows input[type="number"][data-vendor="${i}"][data-key="${key}"]`);
                if (input && input.value) {
                    accTotal += parseFloat(input.value) || 0;
                    hasEstimates = true;
                }
            });

            return {
                vendor: r.supplier,
                baseFsc: r.baseAndFsc,
                accTotal: accTotal,
                allIn: r.baseAndFsc + accTotal,
                hasEstimates: hasEstimates
            };
        });

        // Find best and worst
        const allInValues = vendorTotals.map(v => v.allIn);
        const minTotal = Math.min(...allInValues);
        const maxTotal = Math.max(...allInValues);

        let html = '<h3>All-In Comparison</h3>';
        html += '<div class="compare-totals-grid">';

        vendorTotals.forEach((vt, i) => {
            const isBest = vendorTotals.length > 1 && vt.allIn === minTotal;
            const isWorst = vendorTotals.length > 1 && vt.allIn === maxTotal && minTotal !== maxTotal;
            const diff = vt.allIn - minTotal;

            let cardClass = 'compare-total-card';
            if (isBest) cardClass += ' best';
            if (isWorst) cardClass += ' worst';

            html += `<div class="${cardClass}">
                <div class="ct-vendor">${truncateText(vt.vendor, 22)}</div>
                <div class="ct-base">Base+FSC: ${formatCurrency(vt.baseFsc)}</div>
                <div class="ct-acc">Accessorials: ${formatCurrency(vt.accTotal)}${vt.hasEstimates ? '*' : ''}</div>
                <div class="ct-total">${formatCurrency(vt.allIn)}</div>
                ${isBest ? '<div class="ct-diff">Lowest</div>' : ''}
                ${isWorst ? `<div class="ct-diff">+${formatCurrency(diff)} vs lowest</div>` : ''}
                ${!isBest && !isWorst && vendorTotals.length > 1 ? `<div class="ct-diff">+${formatCurrency(diff)}</div>` : ''}
            </div>`;
        });

        html += '</div>';

        totalsDiv.innerHTML = html;
    }

    // Close compare panel on Escape
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && document.getElementById('comparePanel').classList.contains('active')) {
            closeComparePanel();
        }
    });

    /* ================================================================
       INIT
       ================================================================ */
    window.addEventListener('DOMContentLoaded', init);
    </script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</body>
</html>
